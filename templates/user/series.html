<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Servo - Series</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../../static/css/user/series.css">
    
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        {% include 'user/components/sidebar.html' %}

        <!-- Main Content -->
        <main class="main">
            <!-- Header -->
            <header class="header">
                <input type="text" class="search-input" placeholder="Search series..." id="searchInput">
                
                <div class="header-right">
                    <div class="notification-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                        </svg>
                        <div class="notification-dot"></div>
                    </div>
                    <div class="user-avatar">U</div>
                </div>
            </header>

            <!-- Content -->
            <div class="content">
                <div class="page-title">Series</div>

                <!-- Category Filter -->
                <div class="category-filter">
                    <button class="category-btn active" data-category="all">All</button>
                </div>

                <!-- Series Grid -->
                <div class="series-grid" id="seriesGrid">
                    <!-- Series cards will be generated by JavaScript -->
                </div>

                <!-- Empty State (Hidden by default) -->
                <div class="empty-state" id="emptyState" style="display: none;">
                    <div class="empty-icon">üì∫</div>
                    <div class="empty-title">No Series Found</div>
                    <div class="empty-text">Try adjusting your filters or search criteria</div>
                </div>
            </div>
        </main>
    </div>

    <script src="../../static/js/app-manager.js"></script>
    <script src="../../static/js/streaming-manager.js"></script>
    
    <script>
        /**
         * Desktop Series App - Ÿäÿ≠ÿ∂ÿ± ŸàŸäÿ¥ÿ∫ŸÑ ÿßŸÑŸÖÿ≥ŸÑÿ≥ŸÑÿßÿ™
         */
        class DesktopSeriesApp {
            constructor() {
                this.streamingManager = null;
                this.allSeries = [];
                this.filteredSeries = [];
                this.currentCategory = 'all';
                this.isInitialized = false;

                // DOM Elements
                this.searchInput = document.getElementById('searchInput');
                this.seriesGrid = document.getElementById('seriesGrid');
                this.emptyState = document.getElementById('emptyState');

                this.setupEventListeners();
                this.init();
            }

            setupEventListeners() {
                // Search input
                if (this.searchInput) {
                    this.searchInput.addEventListener('input', (e) => this.handleSearch(e));
                }

                // Category filter
                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('category-btn')) {
                        this.handleCategoryChange(e);
                    }
                });
            }

            async init() {
                console.log('üé¨ Loading series...');
                try {
                    // Initialize streaming manager
                    if (typeof StreamingManager === 'undefined') {
                        throw new Error('StreamingManager not loaded');
                    }

                    this.streamingManager = new StreamingManager();
                    await this.streamingManager.init();

                    // Get series from IPTV content
                    this.allSeries = this.streamingManager.getContentByType('series');
                    this.filteredSeries = [...this.allSeries];

                    console.log(`‚úÖ Loaded ${this.allSeries.length} series`);

                    // Render immediately
                    this.render();
                    this.isInitialized = true;

                } catch (error) {
                    console.error('‚ùå Error loading series:', error);
                    this.showError('Failed to load series');
                }
            }

            render() {
                this.renderCategories();
                this.renderSeries();
            }

            renderCategories() {
                const filterContainer = document.querySelector('.category-filter');
                if (!filterContainer) return;

                const categories = this.getUniqueCategories();

                let html = `
                    <button class="category-btn ${this.currentCategory === 'all' ? 'active' : ''}" data-category="all">
                        All (${this.allSeries.length})
                    </button>
                `;

                categories.forEach(category => {
                    const count = this.getSeriesByCategory(category).length;
                    html += `
                        <button class="category-btn ${this.currentCategory === category ? 'active' : ''}" data-category="${category}">
                            ${category} (${count})
                        </button>
                    `;
                });

                filterContainer.innerHTML = html;
            }

            renderSeries() {
                if (!this.seriesGrid) return;

                this.seriesGrid.innerHTML = '';

                if (this.filteredSeries.length === 0) {
                    this.emptyState.style.display = 'flex';
                    return;
                }

                this.emptyState.style.display = 'none';

                const fragment = document.createDocumentFragment();
                
                this.filteredSeries.forEach((series, index) => {
                    const card = this.createSeriesCard(series, index);
                    fragment.appendChild(card);
                });
                
                this.seriesGrid.appendChild(fragment);
            }

            createSeriesCard(series, index) {
                const card = document.createElement('button');
                card.className = 'series-card';
                card.dataset.seriesId = series.id;
                card.type = 'button';

                const title = (series.name || 'Series').substring(0, 30);
                let poster = series.logo;
                
                if (!poster || poster.includes('imgur.com')) {
                    poster = `https://placehold.co/200x300/1a1a2e/ffffff?text=${encodeURIComponent(title)}`;
                }

                const group = series.group || 'Uncategorized';
                const rating = series.rating || series.imdb || '8.0';

                card.innerHTML = `
                    <div class="series-poster">
                        <img src="${poster}" alt="${title}" 
                             onerror="this.src='https://placehold.co/200x300/1a1a2e/ffffff?text=${encodeURIComponent(title)}'">
                        <button class="play-button" type="button" title="Play">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="white">
                                <polygon points="5 3 19 12 5 21 5 3"></polygon>
                            </svg>
                        </button>
                    </div>
                    <div class="series-info">
                        <div class="series-title">${title}</div>
                        <div class="series-meta">
                            <span class="series-year">${group}</span>
                            <span class="series-rating">‚≠ê ${rating}</span>
                        </div>
                    </div>
                `;

                card.addEventListener('click', () => this.playSeries(series));
                return card;
            }

            playSeries(series) {
                console.log('üìÇ Opening series details:', series.name);
                // Navigate to series details page
                window.location.href = `/series-details?id=${series.id}`;
            }

            handleSearch(e) {
                const searchTerm = e.target.value.toLowerCase();
                
                this.filteredSeries = this.allSeries.filter(series => {
                    const matchesSearch = series.name.toLowerCase().includes(searchTerm) ||
                                        (series.group || '').toLowerCase().includes(searchTerm);
                    const matchesCategory = this.currentCategory === 'all' || 
                                          series.group === this.currentCategory;
                    return matchesSearch && matchesCategory;
                });

                this.renderSeries();
            }

            handleCategoryChange(e) {
                this.currentCategory = e.target.dataset.category;
                
                if (this.currentCategory === 'all') {
                    this.filteredSeries = [...this.allSeries];
                } else {
                    this.filteredSeries = this.getSeriesByCategory(this.currentCategory);
                }

                this.render();
            }

            getUniqueCategories() {
                const categories = new Set();
                this.allSeries.forEach(series => {
                    if (series.group) {
                        categories.add(series.group);
                    }
                });
                return Array.from(categories).sort();
            }

            getSeriesByCategory(category) {
                return this.allSeries.filter(series => series.group === category);
            }

            showError(message) {
                const msg = document.createElement('div');
                msg.textContent = message;
                msg.style.cssText = `
                    position: fixed;
                    bottom: 100px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: #ef4444;
                    color: white;
                    padding: 12px 20px;
                    border-radius: 8px;
                    font-size: 14px;
                    z-index: 1000;
                `;
                document.body.appendChild(msg);
                setTimeout(() => msg.remove(), 3000);
            }
        }

        // Initialize app when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                window.desktopSeriesApp = new DesktopSeriesApp();
            });
        } else {
            window.desktopSeriesApp = new DesktopSeriesApp();
        }
    </script>
    
    <!-- Sidebar menu navigation -->
    <script>
        document.querySelectorAll('.menu-item').forEach(item => {
            item.addEventListener('click', function() {
                document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
                this.classList.add('active');
            });
        });

        // Notification icon click
        const notificationIcon = document.querySelector('.notification-icon');
        if (notificationIcon) {
            notificationIcon.addEventListener('click', function() {
                console.log('Notifications viewed');
            });
        }

        // User avatar click
        const userAvatar = document.querySelector('.user-avatar');
        if (userAvatar) {
            userAvatar.addEventListener('click', function() {
                console.log('User menu clicked');
            });
        }

        // Logout button
        const logoutButton = document.querySelector('.logout-button');
        if (logoutButton) {
            logoutButton.addEventListener('click', function() {
                window.location.href = '/logout';
            });
        }
    </script>
</body>
</html>
