<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Servo - Movies</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../../static/css/user/mobile/movies.css">
    <link rel="stylesheet" href="../../static/css/user/mobile/components/bottom-nav.css">
</head>
<body>
    <header class="mobile-header">
        <h1 class="greeting-name">Movies</h1>
        <div class="search-container">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="search-icon">
                <path d="m21 21-4.34-4.34"></path>
                <circle cx="11" cy="11" r="8"></circle>
            </svg>
            <input type="text" id="searchInput" class="search-input" placeholder="Search movies...">
        </div>
    </header>

    <main class="mobile-main">
        <!-- Category Filter -->
        <div class="category-filter">
            <button class="category-btn active" data-category="all">All</button>
            <button class="category-btn" data-category="action">Action</button>
            <button class="category-btn" data-category="comedy">Comedy</button>
            <button class="category-btn" data-category="drama">Drama</button>
            <button class="category-btn" data-category="horror">Horror</button>
            <button class="category-btn" data-category="scifi">Sci-Fi</button>
        </div>

        <div class="movies-grid" id="moviesGrid">
            <!-- Movie cards will be generated by JavaScript -->
        </div>

        <div class="bottom-spacer"></div>
    </main>

    <!-- BOTTOM NAVIGATION COMPONENT -->
    {% include 'user/mobile/components/bottom-nav.html' %}

    <script>
        class MobileMoviesApp {
            constructor() {
                this.allMovies = [];
                this.filteredMovies = [];
                this.currentCategory = 'all';
                this.searchQuery = '';
                this.streamingManager = null;

                this.moviesGrid = document.getElementById('moviesGrid');
                this.categoryButtons = document.querySelectorAll('.category-btn');
                this.searchInput = document.getElementById('searchInput');

                this.init();
            }

            async init() {
                console.log('Loading movies...');
                try {
                    // Initialize streaming manager
                    this.streamingManager = new StreamingManager();
                    await this.streamingManager.init();

                    // Get movies from IPTV content
                    this.allMovies = this.streamingManager.getContentByType('movies');
                    this.filteredMovies = [...this.allMovies];

                    console.log(`Loaded ${this.allMovies.length} movies`);

                    if (this.allMovies.length === 0) {
                        console.warn('No movies available');
                    }

                    // Render and setup
                    this.render();
                    this.setupEventListeners();

                } catch (error) {
                    console.error('Error loading movies:', error);
                    this.showError('Failed to load movies');
                }
            }

            render() {
                this.renderCategories();
                this.renderMovies();
            }

            renderCategories() {
                const filterContainer = document.querySelector('.category-filter');
                if (!filterContainer) return;

                const categories = this.getUniqueCategories();

                let html = `
                    <button class="category-btn ${this.currentCategory === 'all' ? 'active' : ''}" data-category="all">
                        All (${this.allMovies.length})
                    </button>
                `;

                categories.forEach(category => {
                    const count = this.getMoviesByCategory(category).length;
                    html += `
                        <button class="category-btn ${this.currentCategory === category ? 'active' : ''}" data-category="${category}">
                            ${category} (${count})
                        </button>
                    `;
                });

                filterContainer.innerHTML = html;

                // Re-attach event listeners after re-rendering
                document.querySelectorAll('.category-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => this.handleCategoryChange(e));
                });
            }

            renderMovies() {
                if (!this.moviesGrid) {
                    console.warn('Grid #moviesGrid not found');
                    return;
                }

                this.moviesGrid.innerHTML = '';

                if (this.filteredMovies.length === 0) {
                    this.moviesGrid.innerHTML = '<p class="no-results">No movies found</p>';
                    return;
                }

                this.filteredMovies.forEach((movie) => {
                    const card = this.createMovieCard(movie);
                    this.moviesGrid.appendChild(card);
                });
            }

            createMovieCard(movie, index) {
                const card = document.createElement('button');
                card.className = 'movie-card';
                card.dataset.movieId = movie.id;
                card.dataset.index = index;
                card.type = 'button';

                const movieName = (movie.name || 'Movie').substring(0, 15);
                const title = movie.name || 'Unknown Movie';
                const placeholderSvg = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='450'%3E%3Crect fill='%23222' width='300' height='450'/%3E%3Ctext x='50%25' y='50%25' font-size='14' fill='%23888' text-anchor='middle' dy='.3em'%3ENo Image%3C/text%3E%3C/svg%3E`;
                
                // استخدام خدمة بديلة بدل imgur و via.placeholder.com
                let moviePoster = movie.logo || placeholderSvg;
                if (moviePoster && moviePoster.includes('imgur.com')) {
                    moviePoster = `https://placehold.co/300x450/1a1a2e/ffffff?text=${encodeURIComponent(title)}`;\n                }

                card.innerHTML = `\n                    <img src="${moviePoster}" alt="${title.replace(/"/g, '&quot;')}" class="movie-image" loading="lazy" onerror="this.src='https://placehold.co/300x450/1a1a2e/ffffff?text=${encodeURIComponent(title)}'">
                    <div class="new-badge">NEW</div>
                    <div class="movie-info">
                        <div class="movie-info-content">
                            <h3 class="movie-title">${title}</h3>
                            <div class="movie-meta">
                                <span class="rating">
                                    <svg viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M11.525 2.295a.53.53 0 0 1 .95 0l2.31 4.679a2.123 2.123 0 0 0 1.595 1.16l5.166.756a.53.53 0 0 1 .294.904l-3.736 3.638a2.123 2.123 0 0 0-.611 1.878l.882 5.14a.53.53 0 0 1-.771.56l-4.618-2.428a2.122 2.122 0 0 0-1.973 0L6.396 21.01a.53.53 0 0 1-.77-.56l.881-5.139a2.122 2.122 0 0 0-.611-1.879L2.16 9.795a.53.53 0 0 1 .294-.906l5.165-.755a2.122 2.122 0 0 0 1.597-1.16z"></path>
                                    </svg>
                                    8.5
                                </span>
                                <span>•</span>
                                <span>${movie.group}</span>
                            </div>
                            <div class="movie-actions">
                                <button class="play-btn" type="button" data-index="${index}">
                                    <svg viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M5 5a2 2 0 0 1 3.008-1.728l11.997 6.998a2 2 0 0 1 .003 3.458l-12 7A2 2 0 0 1 5 19z"></path>
                                    </svg>
                                    PLAY
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                // Add event listener for play button
                const playBtn = card.querySelector('.play-btn');
                playBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.playMovie(movie);
                });

                // Add event listener for card click
                card.addEventListener('click', () => {
                    this.playMovie(movie);
                });

                // Add image error handler
                const img = card.querySelector('.movie-image');
                if (img && movie.logo) {
                    img.addEventListener('error', function onImageError() {
                        if (this.src !== placeholderSvg) {
                            this.src = placeholderSvg;
                            this.style.backgroundColor = '#222';
                        }
                    }, { once: false });
                }

                return card;
            }

            setupEventListeners() {
                // Search
                if (this.searchInput) {
                    this.searchInput.addEventListener('input', (e) => this.handleSearch(e));
                }

                // Category buttons
                document.querySelectorAll('.category-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => this.handleCategoryChange(e));
                });
            }

            handleCategoryChange(event) {
                const btn = event.target.closest('.category-btn');
                if (!btn) return;

                this.currentCategory = btn.dataset.category;
                this.filterMovies();
            }

            handleSearch(event) {
                this.searchQuery = event.target.value.toLowerCase();
                this.filterMovies();
            }

            filterMovies() {
                let filtered = [...this.allMovies];

                // Filter by category
                if (this.currentCategory !== 'all') {
                    filtered = filtered.filter(movie => {
                        const category = (movie.group || '').toLowerCase();
                        return category === this.currentCategory.toLowerCase();
                    });
                }

                // Filter by search query
                if (this.searchQuery) {
                    filtered = filtered.filter(movie => {
                        const title = (movie.name || '').toLowerCase();
                        return title.includes(this.searchQuery);
                    });
                }

                this.filteredMovies = filtered;
                this.renderMovies();
            }

            getUniqueCategories() {
                const categories = new Set();
                this.allMovies.forEach(movie => {
                    if (movie.group) {
                        categories.add(movie.group);
                    }
                });
                return Array.from(categories);
            }

            getMoviesByCategory(category) {
                return this.allMovies.filter(movie => 
                    (movie.group || '').toLowerCase() === category.toLowerCase()
                );
            }

            playMovie(movie) {
                try {
                    console.log(`Playing: ${movie.name}`);
                    
                    if (!movie.streamUrl) {
                        this.showError('No stream URL for this movie');
                        return;
                    }
                    
                    // Record as watched
                    this.recordWatched(movie);
                    
                    // Open inline player modal
                    this.openPlayerModal(movie);
                    
                } catch (error) {
                    console.error('Error playing movie:', error);
                    this.showError('Failed to play movie. Please try again.');
                }
            }

            recordWatched(movie) {
                try {
                    const watched = JSON.parse(localStorage.getItem('watched_items') || '[]');
                    
                    // Remove if already exists
                    const filtered = watched.filter(w => w.id !== movie.id);
                    
                    // Add to front
                    const item = {
                        id: movie.id,
                        name: movie.name,
                        logo: movie.logo,
                        group: movie.group,
                        type: 'movies',
                        streamUrl: movie.streamUrl,
                        timestamp: Date.now(),
                        progress: 0
                    };
                    
                    filtered.unshift(item);
                    
                    // Keep only last 50
                    filtered.splice(50);
                    
                    // Save to localStorage
                    localStorage.setItem('watched_items', JSON.stringify(filtered));
                    
                    console.log('Watched item recorded');
                } catch (error) {
                    console.warn('Error recording watched item:', error);
                }
            }

            openPlayerModal(movie) {
                // Check if player modal already exists
                let modal = document.getElementById('movie-player-modal');
                if (modal) {
                    modal.remove();
                }

                modal = document.createElement('div');
                modal.id = 'movie-player-modal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0, 0, 0, 0.98);
                    z-index: 9999;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
                `;

                modal.innerHTML = `
                    <button id="close-player-btn" style="
                        position: absolute;
                        top: 10px;
                        right: 10px;
                        width: 40px;
                        height: 40px;
                        background: rgba(255, 255, 255, 0.2);
                        border: none;
                        border-radius: 50%;
                        color: white;
                        font-size: 24px;
                        cursor: pointer;
                        z-index: 10000;
                    ">✕</button>
                    
                    <video id="movie-video-player" style="
                        width: 100%;
                        height: 100%;
                        max-width: 100%;
                        max-height: 100%;
                        object-fit: contain;
                    " controls autoplay playsinline>
                        <source src="${movie.streamUrl}" type="application/x-mpegURL">
                        Your browser does not support video playback
                    </video>
                    
                    <div style="
                        position: absolute;
                        bottom: 20px;
                        left: 0;
                        right: 0;
                        color: white;
                        text-align: center;
                        background: linear-gradient(transparent, rgba(0,0,0,0.7));
                        padding: 20px;
                    ">
                        <h3 style="margin: 0 0 5px 0;">${movie.name}</h3>
                        <p style="margin: 0; opacity: 0.8;">${movie.group}</p>
                    </div>
                `;

                document.body.appendChild(modal);

                // Close button handler
                document.getElementById('close-player-btn').addEventListener('click', () => {
                    const video = document.getElementById('movie-video-player');
                    if (video) {
                        video.pause();
                    }
                    modal.remove();
                });

                // Close on pressing Escape
                const closeOnEscape = (e) => {
                    if (e.key === 'Escape') {
                        const video = document.getElementById('movie-video-player');
                        if (video) {
                            video.pause();
                        }
                        modal.remove();
                        document.removeEventListener('keydown', closeOnEscape);
                    }
                };
                document.addEventListener('keydown', closeOnEscape);
            }

            showError(message) {
                const toast = document.createElement('div');
                toast.style.cssText = `
                    position: fixed;
                    bottom: 80px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: rgba(239, 68, 68, 0.9);
                    color: white;
                    padding: 12px 20px;
                    border-radius: 8px;
                    z-index: 1000;
                    font-size: 14px;
                    max-width: 300px;
                    text-align: center;
                `;
                toast.textContent = message;
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            }
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            new MobileMoviesApp();
        });
    </script>

    <!-- Streaming Manager -->
    <script src="../../static/js/streaming-manager.js"></script>
