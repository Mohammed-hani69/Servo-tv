<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Movies - Servo</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../../static/css/user/movies.css">



</head>
<body>
    <div class="app-container">
        <!-- Sidebar Navigation -->
        {% include 'user/components/sidebar.html' %}

        <!-- Main Content -->
        <main class="main-content">
            <div class="content-wrapper">
                <!-- Header -->
                <div class="header">
                    <h1 class="page-title">Movies library</h1>
                    <div class="search-container">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="search-icon">
                            <path d="m21 21-4.34-4.34"></path>
                            <circle cx="11" cy="11" r="8"></circle>
                        </svg>
                        <input type="text" id="searchInput" class="search-input tv-focus" placeholder="Search movies...">
                    </div>
                </div>

                <!-- Category Filter -->
                <div class="category-filter">
                    <button class="category-btn tv-focus active" data-category="all">All</button>
                    <button class="category-btn tv-focus" data-category="action">Action</button>
                    <button class="category-btn tv-focus" data-category="comedy">Comedy</button>
                    <button class="category-btn tv-focus" data-category="drama">Drama</button>
                    <button class="category-btn tv-focus" data-category="horror">Horror</button>
                    <button class="category-btn tv-focus" data-category="scifi">Sci-Fi</button>
                </div>

                <!-- Movies Grid -->
                <div class="movies-grid" id="moviesGrid">
                    <!-- Movie cards will be generated by JavaScript -->
                </div>
            </div>
        </main>
    </div>

    <!-- Streaming Manager -->
    <script src="../../static/js/streaming-manager.js"></script>

    <script>
        // Removed static movies data - using StreamingManager instead
        
        // State management
        let currentCategory = 'all';
        let searchQuery = '';
        let allMovies = [];
        let filteredMovies = [];
        let streamingManager = null;

        // DOM elements
        const moviesGrid = document.getElementById('moviesGrid');
        const categoryButtons = document.querySelectorAll('.category-btn');
        const searchInput = document.getElementById('searchInput');

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('Loading movies...');
            try {
                // Initialize streaming manager
                streamingManager = new StreamingManager();
                await streamingManager.init();
                
                // Get movies from IPTV
                allMovies = streamingManager.getContentByType('movies');
                filteredMovies = [...allMovies];
                
                console.log(`Loaded ${allMovies.length} movies`);
                
                renderMovies(filteredMovies);
                setupEventListeners();
                setupKeyboardNavigation();
                
            } catch (error) {
                console.error('Error loading movies:', error);
                moviesGrid.innerHTML = '<div class="no-content">Failed to load movies</div>';
            }
        });

        /**
        * Setup event listeners
        */
        function setupEventListeners() {
            // Category filter
            categoryButtons.forEach(btn => {
                btn.addEventListener('click', (e) => handleCategoryChange(e));
            });

            // Search
            searchInput.addEventListener('input', (e) => handleSearch(e));
        }

        /**
        * Handle category change
        */
        function handleCategoryChange(event) {
            const btn = event.target.closest('.category-btn');
            if (!btn) return;

            currentCategory = btn.dataset.category;

            // Update active state
            categoryButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            // Filter movies
            filterMovies();
        }

        /**
        * Handle search input
        */
        function handleSearch(event) {
            searchQuery = event.target.value.toLowerCase();
            filterMovies();
        }

        /**
        * Filter movies based on category and search
        */
        function filterMovies() {
            let filtered = allMovies;

            // Filter by category
            if (currentCategory !== 'all') {
                filtered = filtered.filter(movie => {
                    const category = (movie.group || '').toLowerCase();
                    return category === currentCategory.toLowerCase();
                });
            }

            // Filter by search query
            if (searchQuery) {
                filtered = filtered.filter(movie => {
                    const title = (movie.name || '').toLowerCase();
                    return title.includes(searchQuery);
                });
            }

            filteredMovies = filtered;
            renderMovies(filteredMovies);
        }

        /**
        * Render movies to grid
        */
        function renderMovies(movies) {
            moviesGrid.innerHTML = '';

            if (movies.length === 0) {
                moviesGrid.innerHTML = '<p class="no-results">No movies found</p>';
                return;
            }

            movies.forEach((movie, index) => {
                const card = createMovieCard(movie, index);
                moviesGrid.appendChild(card);
            });
        }

        /**
        * Create movie card element
        */
        function createMovieCard(movie, index) {
            const card = document.createElement('button');
            card.className = 'movie-card tv-focus';
            card.tabIndex = index;
            card.dataset.movieId = movie.id;
            card.dataset.streamUrl = movie.streamUrl || '';

            const movieName = (movie.name || 'Movie').substring(0, 15);
            const placeholderSvg = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='450'%3E%3Crect fill='%23222' width='300' height='450'/%3E%3Ctext x='50%25' y='50%25' font-size='14' fill='%23888' text-anchor='middle' dy='.3em'%3ENo Image%3C/text%3E%3C/svg%3E`;

            card.innerHTML = `
                <img src="${movie.logo || placeholderSvg}" alt="${(movie.name || 'Movie').replace(/"/g, '&quot;')}" class="movie-image" loading="lazy">
                <div class="new-badge">NEW</div>
                <div class="movie-info">
                    <div class="movie-info-content">
                        <h3 class="movie-title">${movie.name || 'Unknown'}</h3>
                        <div class="movie-meta">
                            <span class="rating">
                                <svg viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M11.525 2.295a.53.53 0 0 1 .95 0l2.31 4.679a2.123 2.123 0 0 0 1.595 1.16l5.166.756a.53.53 0 0 1 .294.904l-3.736 3.638a2.123 2.123 0 0 0-.611 1.878l.882 5.14a.53.53 0 0 1-.771.56l-4.618-2.428a2.122 2.122 0 0 0-1.973 0L6.396 21.01a.53.53 0 0 1-.77-.56l.881-5.139a2.122 2.122 0 0 0-.611-1.879L2.16 9.795a.53.53 0 0 1 .294-.906l5.165-.755a2.122 2.122 0 0 0 1.597-1.16z"></path>
                                </svg>
                                8.5
                            </span>
                            <span>•</span>
                            <span>${movie.group || 'Movies'}</span>
                            <span>•</span>
                            <span class="quality-badge">HD</span>
                        </div>
                        <div class="movie-actions">
                            <button class="play-btn" type="button">
                                <svg viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M5 5a2 2 0 0 1 3.008-1.728l11.997 6.998a2 2 0 0 1 .003 3.458l-12 7A2 2 0 0 1 5 19z"></path>
                                </svg>
                                PLAY
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // Click handler for card selection
            card.addEventListener('click', () => {
                if (movie.streamUrl) {
                    playMovie(movie);
                } else {
                    console.warn('No stream URL for movie:', movie.name);
                    showError('No stream URL for this movie');
                }
            });

            // Add image error handler - set src directly to placeholder on error
            const img = card.querySelector('.movie-image');
            if (img && movie.logo) {
                img.addEventListener('error', function onImageError() {
                    if (this.src !== placeholderSvg) {
                        this.src = placeholderSvg;
                        this.style.backgroundColor = '#222';
                    }
                }, { once: false });
            }

            return card;
        }

        /**
        * Play movie
        */
        function playMovie(movie) {
            try {
                console.log('Playing:', movie.name);
                
                if (!movie.streamUrl) {
                    throw new Error('No stream URL');
                }
                
                // Record as watched
                recordWatched(movie);
                
                // Close any existing player
                closePlayer();
                
                // Open new player
                openPlayer(movie);
                
            } catch (error) {
                console.error('Error playing movie:', error);
                showError(`Playback failed: ${error.message}`);
            }
        }

        /**
        * Record watched item with playback position
        */
        function recordWatched(movie) {
            try {
                const watched = JSON.parse(localStorage.getItem('watched_items') || '[]');
                
                // Remove if already exists
                const filtered = watched.filter(w => w.id !== movie.id);
                
                // Get current playback position if available
                const video = document.getElementById('video-player');
                const currentTime = video ? video.currentTime : 0;
                
                // Add to front
                const item = {
                    id: movie.id,
                    name: movie.name,
                    logo: movie.logo,
                    group: movie.group,
                    type: 'movies',
                    streamUrl: movie.streamUrl,
                    timestamp: Date.now(),
                    progress: currentTime > 0 ? Math.round((currentTime / (video?.duration || 1)) * 100) : 0,
                    currentTime: currentTime || 0,
                    duration: video?.duration || 0
                };
                
                filtered.unshift(item);
                
                // Keep only last 50
                filtered.splice(50);
                
                // Save to localStorage
                localStorage.setItem('watched_items', JSON.stringify(filtered));
                
                console.log('Watched item recorded at:', Math.floor(currentTime), 'seconds');
            } catch (error) {
                console.warn('Error recording watched item:', error);
            }
        }

        /**
        * Open Player Modal
        */
        function openPlayer(movie) {
            const modal = document.createElement('div');
            modal.id = 'player-modal';
            modal.className = 'player-modal';
            
            // Get saved playback position
            const watched = JSON.parse(localStorage.getItem('watched_items') || '[]');
            const savedItem = watched.find(w => w.id === movie.id);
            const startTime = savedItem && savedItem.currentTime > 0 ? savedItem.currentTime : 0;
            const resumeMessage = startTime > 0 ? `Resume from ${Math.floor(startTime / 60)}:${String(Math.floor(startTime % 60)).padStart(2, '0')}` : '';
            
            modal.innerHTML = `
                <div class="player-content">
                    <button class="player-close" type="button">✕</button>
                    ${resumeMessage ? `<div class="resume-notification">${resumeMessage}</div>` : ''}
                    <video id="video-player" controls autoplay playsinline style="width: 100%; height: 100%; object-fit: contain;">
                        <source src="${movie.streamUrl}" type="application/x-mpegURL">
                        Your browser does not support the video tag.
                    </video>
                    <div class="player-info">
                        <h2>${movie.name}</h2>
                        <p>${movie.group}</p>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            injectPlayerStyles();
            
            // Set playback position after video loads
            const video = document.getElementById('video-player');
            if (startTime > 0) {
                video.addEventListener('loadedmetadata', () => {
                    video.currentTime = startTime;
                    console.log('⏪ استئناف التشغيل من:', startTime, 'ثانية');
                }, { once: true });
            }
            
            // Save playback position periodically
            const saveInterval = setInterval(() => {
                if (!document.getElementById('player-modal')) {
                    clearInterval(saveInterval);
                    return;
                }
                updateWatchedTime(movie, video.currentTime, video.duration);
            }, 5000);
            
            // Close button
            modal.querySelector('.player-close').addEventListener('click', () => {
                clearInterval(saveInterval);
                // Save final position before closing
                recordWatched(movie);
                closePlayer();
            });
            
            // Close on Escape
            const closeOnEscape = (e) => {
                if (e.key === 'Escape') {
                    clearInterval(saveInterval);
                    recordWatched(movie);
                    closePlayer();
                    document.removeEventListener('keydown', closeOnEscape);
                }
            };
            document.addEventListener('keydown', closeOnEscape);
        }

        /**
        * Update watched time without reloading
        */
        function updateWatchedTime(movie, currentTime, duration) {
            try {
                const watched = JSON.parse(localStorage.getItem('watched_items') || '[]');
                const item = watched.find(w => w.id === movie.id);
                
                if (item) {
                    item.currentTime = currentTime;
                    item.duration = duration;
                    item.progress = duration > 0 ? Math.round((currentTime / duration) * 100) : 0;
                    item.timestamp = Date.now();
                    
                    localStorage.setItem('watched_items', JSON.stringify(watched));
                }
            } catch (error) {
                console.warn('Error updating watched time:', error);
            }
        }

        /**
        * Close Player
        */
        function closePlayer() {
            const modal = document.getElementById('player-modal');
            if (modal) {
                const video = modal.querySelector('video');
                if (video) video.pause();
                modal.remove();
            }
        }

        /**
        * Inject Player Styles
        */
        function injectPlayerStyles() {
            if (document.getElementById('player-styles')) return;
            
            const style = document.createElement('style');
            style.id = 'player-styles';
            style.textContent = `
                .player-modal {
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.95);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 9999;
                }
                
                .player-content {
                    position: relative;
                    width: 90%;
                    height: 90%;
                    background: #000;
                    border-radius: 8px;
                    overflow: hidden;
                    display: flex;
                    flex-direction: column;
                }
                
                .player-close {
                    position: absolute;
                    top: 10px;
                    right: 10px;
                    width: 40px;
                    height: 40px;
                    background: rgba(0, 0, 0, 0.7);
                    border: none;
                    color: white;
                    font-size: 24px;
                    cursor: pointer;
                    border-radius: 50%;
                    z-index: 10000;
                }
                
                .player-info {
                    position: absolute;
                    bottom: 0;
                    left: 0;
                    right: 0;
                    background: linear-gradient(transparent, rgba(0, 0, 0, 0.9));
                    padding: 20px;
                    color: white;
                }
                
                .player-info h2 {
                    margin: 0 0 5px 0;
                }
                
                .player-info p {
                    margin: 0;
                    opacity: 0.7;
                }
            `;
            
            document.head.appendChild(style);
        }

        /**
        * Show error message
        */
        function showError(message) {
            const toast = document.createElement('div');
            toast.className = 'error-toast';
            toast.textContent = `❌ ${message}`;
            toast.style.cssText = `
                position: fixed;
                bottom: 20px;
                left: 20px;
                background: #ef4444;
                color: white;
                padding: 12px 20px;
                border-radius: 4px;
                z-index: 10001;
            `;
            
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        /**
        * Setup keyboard navigation for TV remote
        */
        function setupKeyboardNavigation() {
            document.addEventListener('keydown', (e) => handleKeyboardNavigation(e));
        }

        /**
        * Handle keyboard navigation (TV remote support)
        */
        function handleKeyboardNavigation(event) {
            const focusedElement = document.activeElement;

            switch(event.key) {
                case 'ArrowUp':
                    event.preventDefault();
                    moveFocus(focusedElement, 'up');
                    break;
                case 'ArrowDown':
                    event.preventDefault();
                    moveFocus(focusedElement, 'down');
                    break;
                case 'ArrowLeft':
                    event.preventDefault();
                    moveFocus(focusedElement, 'left');
                    break;
                case 'ArrowRight':
                    event.preventDefault();
                    moveFocus(focusedElement, 'right');
                    break;
                case 'Enter':
                    event.preventDefault();
                    if (focusedElement && focusedElement.classList.contains('movie-card')) {
                        focusedElement.click();
                    }
                    break;
            }
        }

        /**
        * Move focus based on direction
        */
        function moveFocus(current, direction) {
            const focusableElements = document.querySelectorAll('.tv-focus');
            const focusableArray = Array.from(focusableElements);
            const currentIndex = focusableArray.indexOf(current);

            if (currentIndex === -1) {
                focusableArray[0]?.focus();
                return;
            }

            let nextIndex = currentIndex;

            switch(direction) {
                case 'up':
                case 'left':
                    nextIndex = (currentIndex - 1 + focusableArray.length) % focusableArray.length;
                    break;
                case 'down':
                case 'right':
                    nextIndex = (currentIndex + 1) % focusableArray.length;
                    break;
            }

            focusableArray[nextIndex]?.focus();
        }
    </script>
</body>
</html>
