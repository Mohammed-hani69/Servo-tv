<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Servo - User Dashboard</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.ico">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../../static/css/user/dashboard.css">
    
</head>
<body>
    <div class="container">
        <!-- SIDEBAR -->
        {% include 'user/components/sidebar.html' %}

        <!-- MAIN CONTENT -->
        <main class="main-content">
            <div class="content-wrapper">
                <!-- HEADER -->
                <div class="header-section">
                    <div class="welcome-text">
                        <div class="welcome-label">welcome_back</div>
                        <h1 class="welcome-name" id="username-display">Loading...</h1>
                    </div>
                    <div class="time-display">
                        <div class="time" dir="ltr" id="time-display">00:00 AM</div>
                        <div class="date" id="date-display">Loading...</div>
                    </div>
                </div>

                <!-- FEATURED CARDS -->
                <div class="card-grid">
                    <!-- Live TV Card -->
                    <button class="card blue">
                        <svg class="card-img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 225"><defs><linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#1e40af;stop-opacity:1" /><stop offset="100%" style="stop-color:#0c4a6e;stop-opacity:1" /></linearGradient></defs><rect width="400" height="225" fill="url(#grad1)"/><text x="200" y="100" font-size="24" fill="white" font-weight="bold" text-anchor="middle" dy=".3em">Live TV</text></svg>
                        <div class="card-content">
                            <div class="card-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="m17 2-5 5-5-5"></path>
                                    <rect width="20" height="15" x="2" y="7" rx="2"></rect>
                                </svg>
                            </div>
                            <h3 class="card-title">Live TV</h3>
                            <p class="card-subtitle">
                                section enter
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="m9 18 6-6-6-6"></path>
                                </svg>
                            </p>
                        </div>
                    </button>

                    <!-- Movies Card -->
                    <button class="card purple">
                        <svg class="card-img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 225"><defs><linearGradient id="grad2" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#7c3aed;stop-opacity:1" /><stop offset="100%" style="stop-color:#4c1d95;stop-opacity:1" /></linearGradient></defs><rect width="400" height="225" fill="url(#grad2)"/><text x="200" y="100" font-size="24" fill="white" font-weight="bold" text-anchor="middle" dy=".3em">Movies</text></svg>
                        <div class="card-content">
                            <div class="card-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <rect width="18" height="18" x="3" y="3" rx="2"></rect>
                                    <path d="M7 3v18"></path>
                                    <path d="M3 7.5h4"></path>
                                    <path d="M3 12h18"></path>
                                    <path d="M3 16.5h4"></path>
                                    <path d="M17 3v18"></path>
                                    <path d="M17 7.5h4"></path>
                                    <path d="M17 16.5h4"></path>
                                </svg>
                            </div>
                            <h3 class="card-title">Movies</h3>
                            <p class="card-subtitle">
                                section_enter
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="m9 18 6-6-6-6"></path>
                                </svg>
                            </p>
                        </div>
                    </button>

                    <!-- Series Card -->
                    <button class="card emerald">
                        <svg class="card-img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 225"><defs><linearGradient id="grad3" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#059669;stop-opacity:1" /><stop offset="100%" style="stop-color:#064e3b;stop-opacity:1" /></linearGradient></defs><rect width="400" height="225" fill="url(#grad3)"/><text x="200" y="100" font-size="24" fill="white" font-weight="bold" text-anchor="middle" dy=".3em">Series</text></svg>
                        <div class="card-content">
                            <div class="card-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="m17 2-5 5-5-5"></path>
                                    <rect width="20" height="15" x="2" y="7" rx="2"></rect>
                                </svg>
                            </div>
                            <h3 class="card-title">Series</h3>
                            <p class="card-subtitle">
                                section_enter
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="m9 18 6-6-6-6"></path>
                                </svg>
                            </p>
                        </div>
                    </button>

                    <!-- Playlists Card -->
                    <button class="card orange">
                        <svg class="card-img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 225"><defs><linearGradient id="grad4" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#f97316;stop-opacity:1" /><stop offset="100%" style="stop-color:#92400e;stop-opacity:1" /></linearGradient></defs><rect width="400" height="225" fill="url(#grad4)"/><text x="200" y="100" font-size="24" fill="white" font-weight="bold" text-anchor="middle" dy=".3em">Playlists</text></svg>
                        <div class="card-content">
                            <div class="card-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M16 5H3"></path>
                                    <path d="M11 12H3"></path>
                                    <path d="M16 19H3"></path>
                                    <path d="M18 9v6"></path>
                                    <path d="M21 12h-6"></path>
                                </svg>
                            </div>
                            <h3 class="card-title">my_playlists</h3>
                            <p class="card-subtitle">
                                section_enter
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="m9 18 6-6-6-6"></path>
                                </svg>
                            </p>
                        </div>
                    </button>
                </div>

                <!-- CONTINUE WATCHING SECTION -->
                <section class="section">
                    <div class="section-header">
                        <div class="section-line blue"></div>
                        <h2 class="section-title">Recently Watched Movies</h2>
                    </div>
                    <div class="carousel" id="moviesCarousel">
                        <div class="empty-state">No movies watched yet</div>
                    </div>
                </section>

                <!-- SERIES WATCHING SECTION -->
                <section class="section">
                    <div class="section-header">
                        <div class="section-line green"></div>
                        <h2 class="section-title">Recently Watched Series</h2>
                    </div>
                    <div class="carousel" id="seriesCarousel">
                        <div class="empty-state">No series watched yet</div>
                    </div>
                </section>

                <!-- CONTINUE WATCHING SECTION -->
                <section class="section">
                    <div class="section-header">
                        <div class="section-line red"></div>
                        <h2 class="section-title" id="continue-title">continue_watching</h2>
                    </div>
                    <div class="carousel" id="continueCarousel">
                        <div class="empty-state">No items watched</div>
                    </div>
                </section>

                <!-- RECENTLY ADDED SECTION -->
                <section class="section">
                    <div class="section-header">
                        <div class="section-line yellow"></div>
                        <h2 class="section-title" id="favorites-title">my_favorites</h2>
                    </div>
                    <div class="item-grid" id="favoritesGrid">
                        <div class="empty-state">No favorite items</div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <script src="../../static/js/streaming-manager.js"></script>
    <script>
        // ============================================
        // Dashboard Manager
        // ============================================
        class DashboardManager {
            constructor() {
                this.streamingManager = null;
                this.watchedItems = JSON.parse(localStorage.getItem('watched_items') || '[]');
                this.favoriteItems = JSON.parse(localStorage.getItem('favorite_items') || '[]');
                this.currentSection = 'movies'; // Default section
                
                this.init();
            }

            async init() {
                console.log('üé¨ ÿ®ÿØÿ° ÿ™ŸáŸäÿ¶ÿ© ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ...');
                try {
                    // Initialize streaming manager
                    this.streamingManager = new StreamingManager();
                    await this.streamingManager.init();

                    // Display username and time
                    this.displayUsername();
                    this.updateClock();
                    setInterval(() => this.updateClock(), 1000);

                    // Setup card listeners BEFORE loading content
                    this.setupCardListeners();

                    // Load initial content (Movies)
                    this.loadSectionContent('movies');

                    // Display separate Movies and Series sections
                    this.displayMoviesSection();
                    this.displaySeriesSection();

                    console.log('‚úÖ ÿ™ŸÖ ÿ™ŸáŸäÿ¶ÿ© ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ ÿ®ŸÜÿ¨ÿßÿ≠');

                } catch (error) {
                    console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ŸáŸäÿ¶ÿ© ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ:', error);
                }
            }

            /**
             * Setup card click listeners
             */
            setupCardListeners() {
                const cards = document.querySelectorAll('.card');
                const pageMap = {
                    'Live TV': '/live-tv',
                    'Movies': '/movies',
                    'Series': '/series',
                    'my_playlists': '/my-list',
                };

                cards.forEach(card => {
                    // Add hover effect
                    card.addEventListener('mouseenter', () => {
                        card.style.transition = 'all 0.3s ease';
                    });

                    // Click handler
                    card.addEventListener('click', (e) => {
                        e.preventDefault();
                        const title = card.querySelector('.card-title').textContent.trim();
                        const page = pageMap[title] || '/movies';
                        
                        // Add active state and loading effect
                        cards.forEach(c => c.classList.remove('active'));
                        card.classList.add('active');
                        card.style.opacity = '0.8';
                        
                        // Add loading indicator
                        const originalContent = card.innerHTML;
                        card.innerHTML = `
                            <div style="position: relative; z-index: 21; display: flex; align-items: center; justify-content: center; height: 100%;">
                                <div style="display: flex; flex-direction: column; align-items: center; gap: 10px;">
                                    <div style="width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.3); border-top: 3px solid white; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                                    <span style="color: white; font-size: 14px;">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</span>
                                </div>
                            </div>
                        `;
                        
                        console.log(`üéØ ÿßŸÑÿßŸÜÿ™ŸÇÿßŸÑ ÿ•ŸÑŸâ: ${title}`);
                        console.log(`üìç URL: ${page}`);
                        
                        // Navigate to the page
                        setTimeout(() => {
                            window.location.href = page;
                        }, 500);
                    });
                });

                // Set Movies as default active
                const defaultCard = Array.from(cards).find(c => 
                    c.querySelector('.card-title').textContent.trim() === 'Movies'
                );
                if (defaultCard) {
                    defaultCard.classList.add('active');
                }
            }

            /**
             * Load content for a section
             */
            async loadSectionContent(section) {
                console.log(`üìÇ ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ŸÇÿ≥ŸÖ: ${section}`);
                this.currentSection = section;

                // Get content by type
                const contentList = this.streamingManager.getContentByType(section);
                
                // Get watched items for this section
                const watchedForSection = this.watchedItems.filter(item => 
                    section === 'playlists' ? item.type === 'playlists' : item.type === section
                );
                
                // Get favorites for this section
                const favoritesForSection = this.favoriteItems.filter(item => 
                    section === 'playlists' ? item.type === 'playlists' : item.type === section
                );

                // Sort watched by timestamp (newest first)
                watchedForSection.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

                // Render sections
                this.renderContinueWatching(watchedForSection);
                this.renderFavorites(favoritesForSection);

                // Update section title
                this.updateSectionTitles(section);
            }

            /**
             * Render continue watching section
             */
            renderContinueWatching(watched) {
                const carousel = document.getElementById('continueCarousel');
                carousel.innerHTML = '';

                if (watched.length === 0) {
                    carousel.innerHTML = '<div class="empty-state">No content watched</div>';
                    return;
                }

                // Show only last 5
                watched.slice(0, 5).forEach(item => {
                    const itemEl = document.createElement('button');
                    itemEl.className = 'carousel-item';
                    const placeholderSvg = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='225'%3E%3Crect fill='%23222' width='400' height='225'/%3E%3Ctext x='50%25' y='50%25' font-size='14' fill='%23888' text-anchor='middle' dy='.3em'%3ENo Image%3C/text%3E%3C/svg%3E`;
                    itemEl.innerHTML = `
                        <img src="${item.logo || placeholderSvg}" 
                             alt="${item.name}" class="carousel-item-img" loading="lazy">
                        <div class="carousel-overlay">
                            <div class="play-button">
                                <svg class="play-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white">
                                    <path d="M5 5a2 2 0 0 1 3.008-1.728l11.997 6.998a2 2 0 0 1 .003 3.458l-12 7A2 2 0 0 1 5 19z"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${item.progress || 0}%"></div>
                        </div>
                    `;

                    // Add image error handler
                    const img = itemEl.querySelector('.carousel-item-img');
                    if (img && item.logo) {
                        img.addEventListener('error', function onImageError() {
                            if (this.src !== placeholderSvg) {
                                this.src = placeholderSvg;
                                this.style.backgroundColor = '#222';
                            }
                        }, { once: false });
                    }

                    itemEl.addEventListener('click', () => {
                        this.playContent(item);
                    });

                    carousel.appendChild(itemEl);
                });
            }

            /**
             * Render favorites section
             */
            renderFavorites(favorites) {
                const grid = document.getElementById('favoritesGrid');
                grid.innerHTML = '';

                if (favorites.length === 0) {
                    grid.innerHTML = '<div class="empty-state">No items were added to the favorites.</div>';
                    return;
                }

                // Show only first 6
                favorites.slice(0, 6).forEach(item => {
                    const itemEl = document.createElement('button');
                    itemEl.className = 'grid-item';
                    const placeholderSvg = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='450'%3E%3Crect fill='%23222' width='300' height='450'/%3E%3Ctext x='50%25' y='50%25' font-size='14' fill='%23888' text-anchor='middle' dy='.3em'%3ENo Image%3C/text%3E%3C/svg%3E`;
                    itemEl.innerHTML = `
                        <div class="grid-item-img-container">
                            <img src="${item.logo || placeholderSvg}" 
                                 alt="${item.name}" class="grid-item-img" loading="lazy">
                            <div class="grid-item-badge">‚≠ê</div>
                        </div>
                        <div class="grid-item-info">
                            <div class="grid-item-title">${item.name || 'Unknown'}</div>
                            <div class="grid-item-meta">${item.group || 'Movies'}</div>
                        </div>
                    `;

                    // Add image error handler
                    const img = itemEl.querySelector('.grid-item-img');
                    if (img && item.logo) {
                        img.addEventListener('error', function onImageError() {
                            if (this.src !== placeholderSvg) {
                                this.src = placeholderSvg;
                                this.style.backgroundColor = '#222';
                            }
                        }, { once: false });
                    }

                    itemEl.addEventListener('click', () => {
                        this.playContent(item);
                    });

                    grid.appendChild(itemEl);
                });
            }

            /**
             * Play content and record it as watched
             */
            playContent(item) {
                console.log('‚ñ∂Ô∏è ÿ™ÿ¥ÿ∫ŸäŸÑ:', item.name);
                
                // Open player in a modal or new window
                this.openPlayer(item);
            }

            /**
             * Open player modal with resume capability
             */
            openPlayer(item) {
                const modal = document.createElement('div');
                modal.id = 'dashboard-player-modal';
                modal.className = 'dashboard-player-modal';
                
                // Get saved playback position
                const startTime = item.currentTime || 0;
                const resumeMessage = startTime > 0 ? `‚è±Ô∏è ÿßÿ≥ÿ™ÿ¶ŸÜÿßŸÅ ŸÖŸÜ ÿßŸÑÿØŸÇŸäŸÇÿ© ${Math.floor(startTime / 60)}:${String(Math.floor(startTime % 60)).padStart(2, '0')}` : '';
                
                modal.innerHTML = `
                    <div class="player-content">
                        <button class="player-close" type="button">‚úï</button>
                        ${resumeMessage ? `<div class="resume-notification">${resumeMessage}</div>` : ''}
                        <video id="dashboard-video-player" controls autoplay playsinline style="width: 100%; height: 100%; object-fit: contain;">
                            <source src="${item.streamUrl}" type="application/x-mpegURL">
                            Your browser does not support the video tag.
                        </video>
                        <div class="player-info">
                            <h2>${item.name}</h2>
                            <p>${item.group || 'Content'}</p>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                this.injectPlayerStyles();
                
                // Set playback position after video loads
                const video = document.getElementById('dashboard-video-player');
                if (startTime > 0) {
                    video.addEventListener('loadedmetadata', () => {
                        video.currentTime = startTime;
                        console.log('‚è™ ÿßÿ≥ÿ™ÿ¶ŸÜÿßŸÅ ÿßŸÑÿ™ÿ¥ÿ∫ŸäŸÑ ŸÖŸÜ:', startTime, 'ÿ´ÿßŸÜŸäÿ©');
                    }, { once: true });
                }
                
                // Save playback position periodically
                const saveInterval = setInterval(() => {
                    if (!document.getElementById('dashboard-player-modal')) {
                        clearInterval(saveInterval);
                        return;
                    }
                    this.updateWatchedTime(item, video.currentTime, video.duration);
                }, 5000);
                
                // Close button
                modal.querySelector('.player-close').addEventListener('click', () => {
                    clearInterval(saveInterval);
                    this.recordWatchedFinal(item, video.currentTime, video.duration);
                    this.closePlayer();
                });
                
                // Close on Escape
                const closeOnEscape = (e) => {
                    if (e.key === 'Escape') {
                        clearInterval(saveInterval);
                        this.recordWatchedFinal(item, video.currentTime, video.duration);
                        this.closePlayer();
                        document.removeEventListener('keydown', closeOnEscape);
                    }
                };
                document.addEventListener('keydown', closeOnEscape);
            }

            /**
             * Close player modal
             */
            closePlayer() {
                const modal = document.getElementById('dashboard-player-modal');
                if (modal) {
                    const video = modal.querySelector('video');
                    if (video) video.pause();
                    modal.remove();
                }
            }

            /**
             * Update watched time without reloading
             */
            updateWatchedTime(item, currentTime, duration) {
                try {
                    const watched = JSON.parse(localStorage.getItem('watched_items') || '[]');
                    const watchedItem = watched.find(w => w.id === item.id);
                    
                    if (watchedItem) {
                        watchedItem.currentTime = currentTime;
                        watchedItem.duration = duration;
                        watchedItem.progress = duration > 0 ? Math.round((currentTime / duration) * 100) : 0;
                        watchedItem.timestamp = Date.now();
                        
                        localStorage.setItem('watched_items', JSON.stringify(watched));
                    }
                } catch (error) {
                    console.warn('Error updating watched time:', error);
                }
            }

            /**
             * Record final watched state
             */
            recordWatchedFinal(item, currentTime, duration) {
                try {
                    const watched = JSON.parse(localStorage.getItem('watched_items') || '[]');
                    const watchedItem = watched.find(w => w.id === item.id);
                    
                    if (watchedItem) {
                        watchedItem.currentTime = currentTime;
                        watchedItem.duration = duration;
                        watchedItem.progress = duration > 0 ? Math.round((currentTime / duration) * 100) : 0;
                        watchedItem.timestamp = Date.now();
                        
                        localStorage.setItem('watched_items', JSON.stringify(watched));
                        console.log('Saved playback position at:', Math.floor(currentTime), 'seconds');
                    }
                } catch (error) {
                    console.warn('Error recording watched item:', error);
                }
            }

            /**
             * Inject player styles
             */
            injectPlayerStyles() {
                if (document.getElementById('dashboard-player-styles')) return;
                
                const style = document.createElement('style');
                style.id = 'dashboard-player-styles';
                style.textContent = `
                    .dashboard-player-modal {
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.95);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 9999;
                    }
                    
                    .player-content {
                        position: relative;
                        width: 90%;
                        height: 90%;
                        background: #000;
                        border-radius: 8px;
                        overflow: hidden;
                        display: flex;
                        flex-direction: column;
                    }
                    
                    .player-close {
                        position: absolute;
                        top: 10px;
                        right: 10px;
                        width: 40px;
                        height: 40px;
                        background: rgba(0, 0, 0, 0.7);
                        border: none;
                        color: white;
                        font-size: 24px;
                        cursor: pointer;
                        border-radius: 50%;
                        z-index: 10000;
                    }
                    
                    .resume-notification {
                        position: absolute;
                        top: 60px;
                        left: 20px;
                        background: rgba(59, 130, 246, 0.9);
                        color: white;
                        padding: 12px 16px;
                        border-radius: 6px;
                        font-size: 14px;
                        z-index: 10001;
                        animation: slideDown 0.3s ease-out;
                    }
                    
                    @keyframes slideDown {
                        from {
                            opacity: 0;
                            transform: translateY(-20px);
                        }
                        to {
                            opacity: 1;
                            transform: translateY(0);
                        }
                    }
                    
                    .player-info {
                        position: absolute;
                        bottom: 0;
                        left: 0;
                        right: 0;
                        background: linear-gradient(transparent, rgba(0, 0, 0, 0.9));
                        padding: 20px;
                        color: white;
                    }
                    
                    .player-info h2 {
                        margin: 0 0 5px 0;
                        font-size: 18px;
                    }
                    
                    .player-info p {
                        margin: 0;
                        opacity: 0.7;
                        font-size: 14px;
                    }
                `;
                
                document.head.appendChild(style);
            }

            /**
             * Record a watched item
             */
            recordWatched(item) {
                const watched = {
                    id: item.id,
                    name: item.name,
                    logo: item.logo,
                    group: item.group,
                    type: item.type,
                    streamUrl: item.streamUrl,
                    timestamp: Date.now(),
                    progress: 0
                };

                // Remove if already exists
                this.watchedItems = this.watchedItems.filter(w => w.id !== item.id);

                // Add to front
                this.watchedItems.unshift(watched);

                // Keep only last 50
                this.watchedItems = this.watchedItems.slice(0, 50);

                // Save to localStorage
                localStorage.setItem('watched_items', JSON.stringify(this.watchedItems));

                // Reload current section
                this.loadSectionContent(this.currentSection);

                // Update separate movie/series sections
                if (item.type === 'movies') {
                    this.displayMoviesSection();
                } else if (item.type === 'series') {
                    this.displaySeriesSection();
                }
            }

            /**
             * Add to favorites
             */
            addToFavorites(item) {
                const favorite = {
                    id: item.id,
                    name: item.name,
                    logo: item.logo,
                    group: item.group,
                    type: item.type,
                    streamUrl: item.streamUrl,
                    addedAt: Date.now()
                };

                // Check if already exists
                if (this.favoriteItems.find(f => f.id === item.id)) {
                    return;
                }

                this.favoriteItems.push(favorite);
                localStorage.setItem('favorite_items', JSON.stringify(this.favoriteItems));

                this.loadSectionContent(this.currentSection);
            }

            /**
             * Remove from favorites
             */
            removeFromFavorites(itemId) {
                this.favoriteItems = this.favoriteItems.filter(f => f.id !== itemId);
                localStorage.setItem('favorite_items', JSON.stringify(this.favoriteItems));

                this.loadSectionContent(this.currentSection);
            }

            /**
             * Display Movies Section
             */
            displayMoviesSection() {
                const carousel = document.getElementById('moviesCarousel');
                const moviesWatched = this.watchedItems.filter(item => item.type === 'movies');
                
                carousel.innerHTML = '';
                
                if (moviesWatched.length === 0) {
                    carousel.innerHTML = '<div class="empty-state">No movies watched</div>';
                    return;
                }
                
                // Show only last 5 movies
                moviesWatched.slice(0, 5).forEach(item => {
                    const itemEl = document.createElement('button');
                    itemEl.className = 'carousel-item';
                    const placeholderSvg = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='225'%3E%3Crect fill='%23222' width='400' height='225'/%3E%3Ctext x='50%25' y='50%25' font-size='14' fill='%23888' text-anchor='middle' dy='.3em'%3ENo Image%3C/text%3E%3C/svg%3E`;
                    itemEl.innerHTML = `
                        <img src="${item.logo || placeholderSvg}" 
                             alt="${item.name}" class="carousel-item-img" loading="lazy">
                        <div class="carousel-overlay">
                            <div class="play-button">
                                <svg class="play-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white">
                                    <path d="M5 5a2 2 0 0 1 3.008-1.728l11.997 6.998a2 2 0 0 1 .003 3.458l-12 7A2 2 0 0 1 5 19z"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${item.progress || 0}%"></div>
                        </div>
                    `;

                    // Add image error handler
                    const img = itemEl.querySelector('.carousel-item-img');
                    if (img && item.logo) {
                        img.addEventListener('error', function onImageError() {
                            if (this.src !== placeholderSvg) {
                                this.src = placeholderSvg;
                                this.style.backgroundColor = '#222';
                            }
                        }, { once: false });
                    }

                    itemEl.addEventListener('click', () => {
                        this.playContent(item);
                    });

                    carousel.appendChild(itemEl);
                });
            }

            /**
             * Display Series Section
             */
            displaySeriesSection() {
                const carousel = document.getElementById('seriesCarousel');
                const seriesWatched = this.watchedItems.filter(item => item.type === 'series');
                
                carousel.innerHTML = '';
                
                if (seriesWatched.length === 0) {
                    carousel.innerHTML = '<div class="empty-state">No series watched</div>';
                    return;
                }
                
                // Show only last 5 series
                seriesWatched.slice(0, 5).forEach(item => {
                    const itemEl = document.createElement('button');
                    itemEl.className = 'carousel-item';
                    const placeholderSvg = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='225'%3E%3Crect fill='%23222' width='400' height='225'/%3E%3Ctext x='50%25' y='50%25' font-size='14' fill='%23888' text-anchor='middle' dy='.3em'%3ENo Image%3C/text%3E%3C/svg%3E`;
                    itemEl.innerHTML = `
                        <img src="${item.logo || placeholderSvg}" 
                             alt="${item.name}" class="carousel-item-img" loading="lazy">
                        <div class="carousel-overlay">
                            <div class="play-button">
                                <svg class="play-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white">
                                    <path d="M5 5a2 2 0 0 1 3.008-1.728l11.997 6.998a2 2 0 0 1 .003 3.458l-12 7A2 2 0 0 1 5 19z"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${item.progress || 0}%"></div>
                        </div>
                    `;

                    // Add image error handler
                    const img = itemEl.querySelector('.carousel-item-img');
                    if (img && item.logo) {
                        img.addEventListener('error', function onImageError() {
                            if (this.src !== placeholderSvg) {
                                this.src = placeholderSvg;
                                this.style.backgroundColor = '#222';
                            }
                        }, { once: false });
                    }

                    itemEl.addEventListener('click', () => {
                        this.playContent(item);
                    });

                    carousel.appendChild(itemEl);
                });
            }

            /**
             * Update section titles
             */
            updateSectionTitles(section) {
                const titles = {
                    'live-tv': 'Recently Watched Channels',
                    'movies': 'Recently Watched Movies',
                    'series': 'Recently Watched Series',
                    'playlists': 'Recently Watched Playlists'
                };

                document.getElementById('continue-title').textContent = titles[section] || 'Continue Watching';
                document.getElementById('favorites-title').textContent = `Favorites - ${section}`;
            }

            /**
             * Display username
             */
            displayUsername() {
                const username = sessionStorage.getItem('username') || 'Guest';
                document.getElementById('username-display').textContent = username;
            }

            /**
             * Update clock
             */
            updateClock() {
                const now = new Date();
                
                let hours = now.getHours();
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const ampm = hours >= 12 ? 'PM' : 'AM';
                hours = hours % 12;
                hours = hours ? hours : 12;
                const timeString = `${String(hours).padStart(2, '0')}:${minutes} ${ampm}`;
                
                const options = { weekday: 'long', month: 'long', day: 'numeric' };
                const dateString = now.toLocaleDateString('en-US', options);
                
                document.getElementById('time-display').textContent = timeString;
                document.getElementById('date-display').textContent = dateString;
            }
        }

        // Initialize dashboard on page load
        document.addEventListener('DOMContentLoaded', () => {
            window.dashboard = new DashboardManager();
        });
    </script>
</body>
</html>
