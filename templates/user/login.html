<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Servo - Device Activation</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../../static/css/user/login.css">
    
</head>
<body>
    <div class="login-container">
        <div class="login-backdrop"></div>
        
        <div class="login-wrapper">
            <!-- Left Panel: QR Code -->
            <div class="login-left">
                <div class="logo-badge">
                    <svg viewBox="0 0 200 200" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <defs>
                            <linearGradient id="logoGradient" x1="0" y1="0" x2="200" y2="200">
                                <stop offset="0%" stop-color="#3B82F6"></stop>
                                <stop offset="100%" stop-color="#2563EB"></stop>
                            </linearGradient>
                            <filter id="glow" x="-20%" y="-20%" width="140%" height="140%">
                                <feGaussianBlur stdDeviation="5" result="coloredBlur"></feGaussianBlur>
                                <feMerge>
                                    <feMergeNode in="coloredBlur"></feMergeNode>
                                    <feMergeNode in="SourceGraphic"></feMergeNode>
                                </feMerge>
                            </filter>
                        </defs>
                        <path d="M45 35C45 23.4477 57.5 16.2274 67.5 22.001L170 81.001C180 86.7746 180 101.225 170 107.0L67.5 165.999C57.5 171.773 45 164.552 45 153.0V35Z" fill="url(#logoGradient)" filter="url(#glow)"></path>
                        <path d="M95 55L75 100H105L85 145L135 90H105L120 55H95Z" fill="white" stroke="white" stroke-width="4" stroke-linejoin="round"></path>
                    </svg>
                </div>

                <h2 class="login-title">scan_activate</h2>

                <div class="qr-box">
                    <svg xmlns="http://www.w3.org/2000/svg" width="180" height="180" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect width="5" height="5" x="3" y="3" rx="1"></rect>
                        <rect width="5" height="5" x="16" y="3" rx="1"></rect>
                        <rect width="5" height="5" x="3" y="16" rx="1"></rect>
                        <path d="M21 16h-3a2 2 0 0 0-2 2v3"></path>
                        <path d="M21 21v.01"></path>
                        <path d="M12 7v3a2 2 0 0 1-2 2H7"></path>
                        <path d="M3 12h.01"></path>
                        <path d="M12 3h.01"></path>
                        <path d="M12 16v.01"></path>
                        <path d="M16 12h1"></path>
                        <path d="M21 12v.01"></path>
                        <path d="M12 21v-1"></path>
                    </svg>
                </div>

                <p class="qr-info-text">Or visit <span class="qr-code-display">servo.tv/activate</span></p>
                <p class="qr-subtext">Enter code shown on your mobile</p>
            </div>

            <!-- Right Panel: Activation Form -->
            <div class="login-right">
                <div class="login-header">
                    <h1 class="login-heading">device_activation</h1>
                    <p class="login-subtitle">enter_code_msg</p>
                </div>

                <div class="device-info">
                    <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="device-icon">
                        <path d="m17 2-5 5-5-5"></path>
                        <rect width="20" height="15" x="2" y="7" rx="2"></rect>
                    </svg>

                    <!-- Device ID -->
                    <div class="device-content">
                        <div>Device ID</div>
                        <div class="device-id" id="device-id-display">DEV-XXXXXXXX</div>
                    </div>

                    <!-- Activation Code -->
                    <div class="device-content">
                        <div>Activation Code</div>
                        <div class="device-id activation-code-display" id="activation-code-display">------</div>
                    </div>

                    <!-- Expiration Timer -->
                    <div class="timer-section">
                        <div class="timer-label">Expiration</div>
                        <div class="timer-display" id="timer-display">10:00</div>
                    </div>
                </div>

                <form class="login-form" id="deviceLoginForm">
                    <!-- Code input removed - button submission only -->

                    <button class="activate-button tv-focus" type="submit" id="activateBtn">
                        <span class="button-text">activate_btn</span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="button-icon">
                            <path d="M5 12h14"></path>
                            <path d="m12 5 7 7-7 7"></path>
                        </svg>
                    </button>

                    <!-- Error Message -->
                    <div id="errorMessage" style="display: none; padding: 1rem; background-color: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.5); border-radius: 0.75rem; color: #fca5a5; text-align: center; font-size: 0.875rem; margin-top: 1rem;">
                    </div>
                </form>

                <div class="login-footer">
                    <p class="terms-text">By activating, you agree to our Terms of Service.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // üéØ Integrated system to retrieve device ID (Roku + Samsung + LG + Fingerprint)

        /**
         * Simple hash function to convert text to unique value
         * Used instead of SHA-256 for simplicity and compatibility with older devices
         */
        function simpleHash(str) {
            let hash = 0;
            if (str.length === 0) return hash.toString(16);
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32bit integer
            }
            return Math.abs(hash).toString(16);
        }

        /**
         * Receive messages from Roku application
         * Roku sends device ID through window postMessage
         */
        let rokuDeviceData = null;
        
        window.addEventListener('message', function(event) {
            console.log('üì® Message received from:', event.origin, event.data);
            
            if (event.data && event.data.type === 'device_data' && event.data.device_source === 'roku') {
                console.log('‚úÖ Received data from Roku:', event.data);
                rokuDeviceData = event.data;
                
                // Update display with Roku data
                if (event.data.device_id) {
                    document.getElementById('device-id-display').textContent = event.data.device_id;
                }
                if (event.data.activation_code) {
                    document.getElementById('activation-code-display').textContent = event.data.activation_code;
                }
                
                // Save data
                sessionStorage.setItem('device_data_source', 'roku');
                sessionStorage.setItem('device_id', event.data.device_id);
                sessionStorage.setItem('activation_code', event.data.activation_code);
            }
        }, false);

        /**
         * Create Device Fingerprint from fixed device properties
         * These properties don't change on the same device unless basic settings are modified
         */
        function generateDeviceFingerprint() {
            try {
                const fingerprints = {
                    // Screen information
                    screen: `${window.screen.width}x${window.screen.height}x${window.screen.colorDepth}`,
                    
                    // Timezone (doesn't change naturally)
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    
                    // Language
                    language: navigator.language || navigator.userLanguage,
                    
                    // User Agent (device and browser identifier)
                    ua: navigator.userAgent.substring(0, 50),
                    
                    // Platform
                    platform: navigator.platform,
                    
                    // Hardware Concurrency (number of processors)
                    hardwareConcurrency: navigator.hardwareConcurrency || 'unknown',
                    
                    // Device Memory (if available)
                    deviceMemory: navigator.deviceMemory || 'unknown',
                    
                    // Max Touch Points
                    maxTouchPoints: navigator.maxTouchPoints || 0,
                    
                    // WebGL Info (if available)
                    webglVendor: (() => {
                        try {
                            const canvas = document.createElement('canvas');
                            const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                            if (gl) {
                                const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
                                if (debugInfo) {
                                    return gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL) || 'unknown';
                                }
                            }
                        } catch (e) {
                            return 'unknown';
                        }
                        return 'unknown';
                    })(),
                };

                // Combine all properties
                const fingerprintString = Object.values(fingerprints).join('||');
                console.log('üìç Fingerprint Components:', fingerprints);
                
                // Convert to unique hash
                const hash = simpleHash(fingerprintString);
                
                // Format: FP-XXXXXXXX (example: FP-a1b2c3d4)
                const deviceFingerprint = `FP-${hash.substring(0, 8).toUpperCase()}`;
                
                console.log('‚úÖ Device Fingerprint:', deviceFingerprint);
                return deviceFingerprint;
            } catch (e) {
                console.log('‚ùå Error creating Fingerprint:', e);
                return null;
            }
        }

        // üéØ Get actual device ID from different devices

        // 1Ô∏è‚É£ Samsung TV (DUID)
        function getSamsungDeviceId() {
            try {
                if (window.webapis && window.webapis.productinfo) {
                    return window.webapis.productinfo.getDuid();
                }
            } catch (e) {
                console.log('‚ùå Samsung DUID not available');
            }
            return null;
        }

        // 2Ô∏è‚É£ LG TV (webOS - Serial Number)
        function getLGDeviceId(callback) {
            try {
                if (window.webOS && window.webOS.service) {
                    window.webOS.service.request(
                        "luna://com.webos.service.tv.systemproperty",
                        {
                            method: "getSystemInfo",
                            parameters: {
                                keys: ["serialNumber"]
                            },
                            onSuccess: function (res) {
                                const serialNumber = res.serialNumber || null;
                                console.log('‚úÖ LG Serial Number:', serialNumber);
                                callback(serialNumber);
                            },
                            onFailure: function () {
                                console.log('‚ùå LG Serial Number not available');
                                callback(null);
                            }
                        }
                    );
                } else {
                    callback(null);
                }
            } catch (e) {
                console.log('‚ùå Error getting LG ID');
                callback(null);
            }
        }

        // 5Ô∏è‚É£ Attempt to get actual device ID from all sources
        async function getActualDeviceId() {
            return new Promise((resolve) => {
                // If we have Roku data, use it directly
                if (rokuDeviceData && rokuDeviceData.device_id) {
                    console.log('‚úÖ Using Roku ID:', rokuDeviceData.device_id);
                    resolve({ id: rokuDeviceData.device_id, source: 'roku' });
                    return;
                }

                // Try Samsung first
                const samsungId = getSamsungDeviceId();
                if (samsungId) {
                    console.log('‚úÖ Samsung DUID:', samsungId);
                    resolve({ id: samsungId, source: 'samsung' });
                    return;
                }

                // Try LG
                getLGDeviceId((lgId) => {
                    if (lgId) {
                        console.log('‚úÖ LG Serial:', lgId);
                        resolve({ id: lgId, source: 'lg' });
                        return;
                    }

                    // If all attempts fail, use Device Fingerprint
                    const fingerprint = generateDeviceFingerprint();
                    console.log('üìç Using Device Fingerprint:', fingerprint);
                    resolve({ id: fingerprint, source: 'fingerprint' });
                });
            });
        }

        // Determine device_type (can be improved later for auto-detection)
        function detectDeviceType() {
            const ua = navigator.userAgent.toLowerCase();
            if (ua.includes('tv') || ua.includes('smarttv') || ua.includes('samsung')) return 'samsung';
            if (ua.includes('lg') || ua.includes('webos')) return 'lg';
            if (ua.includes('android')) return 'android';
            if (ua.includes('roku')) return 'roku';
            if (ua.includes('appletv')) return 'apple-tv';
            return 'web';
        }

        // Send device registration request
        async function registerDevice() {
            try {
                // If we have Roku data, don't re-request
                if (rokuDeviceData && rokuDeviceData.success && rokuDeviceData.device_id) {
                    console.log('‚úÖ Using previous Roku data:', rokuDeviceData.device_id);
                    document.getElementById('device-id-display').textContent = rokuDeviceData.device_id;
                    document.getElementById('activation-code-display').textContent = rokuDeviceData.activation_code;
                    sessionStorage.setItem('device_id', rokuDeviceData.device_id);
                    sessionStorage.setItem('activation_code', rokuDeviceData.activation_code);
                    sessionStorage.setItem('device_data_source', 'roku');
                    startCountdown(rokuDeviceData.expires_in_seconds);
                    return;
                }

                const deviceType = detectDeviceType();
                
                // Attempt to get actual device ID or Fingerprint
                const deviceIdInfo = await getActualDeviceId();
                
                const response = await fetch('/users/api/device/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        device_type: deviceType,
                        actual_device_id: deviceIdInfo.id,  // Real ID or fingerprint
                        device_id_source: deviceIdInfo.source  // ID source (roku/samsung/lg/fingerprint)
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // Display data
                    document.getElementById('device-id-display').textContent = data.device_id;
                    document.getElementById('activation-code-display').textContent = data.activation_code;

                    // Save in session storage for later use
                    sessionStorage.setItem('device_id', data.device_id);
                    sessionStorage.setItem('activation_code', data.activation_code);
                    sessionStorage.setItem('device_data_source', deviceIdInfo.source);

                    // Start countdown timer
                    startCountdown(data.expires_in_seconds);
                } else {
                    console.error('Device registration failed:', data.error);
                }
            } catch (error) {
                console.error('Error during device registration:', error);
            }
        }

        // Countdown timer function
        function startCountdown(totalSeconds) {
            let remainingSeconds = totalSeconds;
            const timerDisplay = document.getElementById('timer-display');

            const countdownInterval = setInterval(() => {
                const minutes = Math.floor(remainingSeconds / 60);
                const seconds = remainingSeconds % 60;
                
                timerDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

                // Change color when approaching expiration
                if (remainingSeconds <= 60) {
                    timerDisplay.style.color = '#ff6b6b';
                } else {
                    timerDisplay.style.color = '#ffffff';
                }

                if (remainingSeconds <= 0) {
                    clearInterval(countdownInterval);
                    timerDisplay.textContent = 'Generating new code...';
                    timerDisplay.style.color = '#fbbf24';
                    
                    // Generate new code automatically after time expires
                    setTimeout(() => {
                        registerDevice();
                    }, 1000);
                } else {
                    remainingSeconds--;
                }
            }, 1000);
        }

        // ============================================================================
        // üü¢ Phase 9: Button submit handler
        // ============================================================================

        document.addEventListener('DOMContentLoaded', function() {
            // Call registration on page load
            registerDevice();

            // Handle button click
            const deviceLoginForm = document.getElementById('deviceLoginForm');
            const activateBtn = document.getElementById('activateBtn');
            const errorMessage = document.getElementById('errorMessage');

            deviceLoginForm.addEventListener('submit', async function(e) {
                e.preventDefault();

                // Get device ID from session storage
                const deviceId = sessionStorage.getItem('device_id');

                if (!deviceId) {
                    showErrorMessage('Device ID not available. Please wait.');
                    return;
                }

                // Add loading state
                activateBtn.disabled = true;
                activateBtn.innerHTML = '<span class="button-text">Loading...</span>';

                try {
                    // ============================================================================
                    // 13Ô∏è‚É£ Send device/login request
                    // ============================================================================
                    const response = await fetch('/users/api/device/login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            device_id: deviceId
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        // ‚úÖ Activation successful - proceed to dashboard
                        console.log('‚úÖ Device login successful:', data.data);
                        
                        // Save data in session storage
                        sessionStorage.setItem('user_token', data.data.token);
                        sessionStorage.setItem('user_id', data.data.user_id);
                        sessionStorage.setItem('username', data.data.username);
                        sessionStorage.setItem('media_link', data.data.media_link || '');
                        
                        // Redirect to dashboard after one second
                        setTimeout(() => {
                            window.location.href = '/users/dashboard';
                        }, 1000);
                    } else {
                        // ‚ùå Activation failed
                        showErrorMessage(data.message || 'Device has not been activated yet');
                        activateBtn.disabled = false;
                        activateBtn.innerHTML = '<span class="button-text">activate_btn</span><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="button-icon"><path d="M5 12h14"></path><path d="m12 5 7 7-7 7"></path></svg>';
                    }
                } catch (error) {
                    console.error('‚ùå Error during device login:', error);
                    showErrorMessage('An error occurred. Please try again.');
                    activateBtn.disabled = false;
                    activateBtn.innerHTML = '<span class="button-text">activate_btn</span><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="button-icon"><path d="M5 12h14"></path><path d="m12 5 7 7-7 7"></path></svg>';
                }
            });

            // Function to display error message
            function showErrorMessage(message) {
                errorMessage.textContent = message;
                errorMessage.style.display = 'block';
            }
        });
    </script>
</body>
</html>