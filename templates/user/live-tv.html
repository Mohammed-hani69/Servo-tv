<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Servo - Live TV</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../../static/css/user/live-tv.css">
    <style>
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #ddd;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .loading-container {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 60vh;
            flex-direction: column;
            gap: 20px;
        }
        .error-message {
            background: #fee;
            color: #c00;
            padding: 12px 16px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        {% include 'user/components/sidebar.html' %}

        <!-- Main Content -->
        <main class="main-content">
            <div class="content-wrapper">
                <!-- Categories Sidebar -->
                <aside class="categories-sidebar">
                    <h2 class="categories-title">üì∫ Categories</h2>
                    <div class="categories-list" id="categoriesList">
                        <div class="loading-spinner"></div>
                    </div>
                </aside>

                <!-- Channels Grid -->
                <section class="channels-section">
                    <div class="channels-header">
                        <h1 class="channels-title" id="channelsTitle">All Channels</h1>
                        <span class="channels-count" id="channelsCount">Loading...</span>
                    </div>

                    <div class="channels-grid" id="channelsGrid">
                        <div class="loading-container">
                            <div class="loading-spinner"></div>
                            <p>Loading channels...</p>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <script>
        /**
         * üì∫ Live TV - Dynamic Channel Loader
         * Loads channels from M3U and displays them by category
         */
        
        class LiveTVController {
            constructor() {
                this.channels = [];
                this.categories = new Map();
                this.favorites = this.loadFavorites();
                this.currentCategory = 'all';
                this.streamingManager = null;
            }

            /**
             * Initialize
             */
            async init() {
                console.log('Initializing Live TV...');
                
                try {
                    // Initialize streaming manager
                    this.streamingManager = new StreamingManager();
                    await this.streamingManager.init();
                    
                    // Get channels from IPTV
                    this.channels = this.streamingManager.getContentByType('live-tv');
                    
                    console.log(`Loaded ${this.channels.length} channels`);
                    
                    // Group categories
                    this.groupChannels();
                    
                    // Display interface
                    this.renderCategories();
                    this.renderChannels();
                    this.setupEventListeners();
                    
                } catch (error) {
                    console.error('Error initializing Live TV:', error);
                    this.showError('Failed to load channels. Verify active subscription.');
                }
            }

            /**
             * Group channels by category
             */
            groupChannels() {
                this.categories.clear();
                
                this.channels.forEach(channel => {
                    const category = channel.group || 'Other';
                    
                    if (!this.categories.has(category)) {
                        this.categories.set(category, []);
                    }
                    
                    this.categories.get(category).push(channel);
                });
            }

            /**
             * Display categories
             */
            renderCategories() {
                const categoriesList = document.getElementById('categoriesList');
                if (!categoriesList) return;
                
                let html = `
                    <button class="category-item active" data-category="all">
                        <span>All</span>
                        <span class="count">(${this.channels.length})</span>
                    </button>
                    <button class="category-item" data-category="favorites">
                        <span>‚ô° Favorites</span>
                        <span class="count">(${this.favorites.length})</span>
                    </button>
                `;
                
                // Add each category
                this.categories.forEach((channels, category) => {
                    html += `
                        <button class="category-item" data-category="${category}">
                            <span>${category}</span>
                            <span class="count">(${channels.length})</span>
                        </button>
                    `;
                });
                
                categoriesList.innerHTML = html;
            }

            /**
             * Display channels
             */
            renderChannels() {
                const channelsGrid = document.getElementById('channelsGrid');
                const channelsCount = document.getElementById('channelsCount');
                const channelsTitle = document.getElementById('channelsTitle');
                
                if (!channelsGrid) return;
                
                // ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÇŸÜŸàÿßÿ™ ÿßŸÑŸÖÿ±ÿßÿØ ÿπÿ±ÿ∂Ÿáÿß
                let channelsToShow = [];
                let titleText = 'ÿ¨ŸÖŸäÿπ ÿßŸÑŸÇŸÜŸàÿßÿ™';
                
                if (this.currentCategory === 'all') {
                    channelsToShow = [...this.channels];
                    titleText = 'ÿ¨ŸÖŸäÿπ ÿßŸÑŸÇŸÜŸàÿßÿ™';
                } else if (this.currentCategory === 'favorites') {
                    channelsToShow = this.channels.filter(ch => this.isFavorite(ch.id));
                    titleText = 'ÿßŸÑŸÇŸÜŸàÿßÿ™ ÿßŸÑŸÖŸÅÿ∂ŸÑÿ©';
                } else {
                    channelsToShow = this.categories.get(this.currentCategory) || [];
                    titleText = this.currentCategory;
                }
                
                // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿπŸÜŸàÿßŸÜ ŸàÿßŸÑÿπÿØÿØ
                channelsTitle.textContent = titleText;
                channelsCount.textContent = `${channelsToShow.length} ŸÇŸÜÿßÿ©`;
                
                // ÿ•ÿ∞ÿß ŸÑŸÖ ÿ™Ÿàÿ¨ÿØ ŸÇŸÜŸàÿßÿ™
                if (channelsToShow.length === 0) {
                    channelsGrid.innerHTML = `
                        <div class="empty-state">
                            <p>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÇŸÜŸàÿßÿ™ ŸÅŸä Ÿáÿ∞Ÿá ÿßŸÑŸÅÿ¶ÿ©</p>
                        </div>
                    `;
                    return;
                }
                
                // ÿ®ŸÜÿßÿ° HTML ŸÑŸÑŸÇŸÜŸàÿßÿ™
                let html = '';
                
                channelsToShow.forEach((channel, index) => {
                    const isFavorite = this.isFavorite(channel.id);
                    const placeholderSvg = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100'%3E%3Crect fill='%23333' width='100' height='100'/%3E%3Ctext x='50%25' y='50%25' font-size='10' fill='%23666' text-anchor='middle' dy='.3em'%3ENo Logo%3C/text%3E%3C/svg%3E`;
                    const logo = channel.logo || placeholderSvg;
                    
                    html += `
                        <div class="channel-card" data-channel-id="${channel.id}" data-index="${index}">
                            <div class="channel-thumbnail">
                                <img 
                                    src="${logo}" 
                                    alt="${channel.name}"
                                    loading="lazy"
                                >
                                <div class="play-overlay">
                                    <button class="play-btn" title="ÿ™ÿ¥ÿ∫ŸäŸÑ">
                                        <svg viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M8 5v14l11-7z"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div class="channel-info">
                                <h3 class="channel-name">${channel.name}</h3>
                                <div class="channel-meta">
                                    <span class="channel-quality">HD</span>
                                    <span class="channel-category">${channel.group}</span>
                                </div>
                            </div>
                            <button class="channel-favorite ${isFavorite ? 'active' : ''}" data-channel-id="${channel.id}" title="${isFavorite ? 'Remove from favorites' : 'Add to favorites'}">
                                <svg viewBox="0 0 24 24" fill="${isFavorite ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2">
                                    <path d="M11.525 2.295a.53.53 0 0 1 .95 0l2.31 4.679a2.123 2.123 0 0 0 1.595 1.16l5.166.756a.53.53 0 0 1 .294.904l-3.736 3.638a2.123 2.123 0 0 0-.611 1.878l.882 5.14a.53.53 0 0 1-.771.56l-4.618-2.428a2.122 2.122 0 0 0-1.973 0L6.396 21.01a.53.53 0 0 1-.77-.56l.881-5.139a2.122 2.122 0 0 0-.611-1.879L2.16 9.795a.53.53 0 0 1 .294-.906l5.165-.755a2.122 2.122 0 0 0 1.597-1.16z"></path>
                                </svg>
                            </button>
                        </div>
                    `;
                });
                
                channelsGrid.innerHTML = html;
                
                // Add event listeners
                this.attachListeners();
            }

            /**
             * Add event listeners
             */
            attachListeners() {
                // Add image error handler
                document.querySelectorAll('.channel-card img').forEach(img => {
                    if (img.src && !img.src.startsWith('data:')) {
                        img.addEventListener('error', function onImageError() {
                            const placeholderSvg = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100'%3E%3Crect fill='%23333' width='100' height='100'/%3E%3Ctext x='50%25' y='50%25' font-size='10' fill='%23666' text-anchor='middle' dy='.3em'%3ENo Logo%3C/text%3E%3C/svg%3E`;
                            if (this.src !== placeholderSvg) {
                                this.src = placeholderSvg;
                                this.style.backgroundColor = '#333';
                            }
                        }, { once: false });
                    }
                });

                // Click on channel
                document.querySelectorAll('.channel-card').forEach(card => {
                    card.addEventListener('click', (e) => {
                        if (!e.target.closest('.channel-favorite')) {
                            const channelId = card.dataset.channelId;
                            const channel = this.channels.find(ch => ch.id === channelId);
                            if (channel) {
                                this.playChannel(channel);
                            }
                        }
                    });
                });
                
                // Favorites button
                document.querySelectorAll('.channel-favorite').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const channelId = btn.dataset.channelId;
                        this.toggleFavorite(channelId);
                    });
                });
            }

            /**
             * Setup category filter event listeners
             */
            setupEventListeners() {
                document.querySelectorAll('.category-item').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const category = e.target.closest('.category-item').dataset.category;
                        this.selectCategory(category);
                    });
                });
            }

            /**
             * Select category
             */
            selectCategory(category) {
                this.currentCategory = category;
                
                // Update buttons
                document.querySelectorAll('.category-item').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`[data-category="${category}"]`)?.classList.add('active');
                
                // Re-render channels
                this.renderChannels();
            }

            /**
             * Play channel
             */
            async playChannel(channel) {
                try {
                    console.log('Playing:', channel.name);
                    
                    // Open player
                    this.openPlayer(channel);
                    
                    // Play from StreamingManager
                    await this.streamingManager.playContent(channel);
                    
                    console.log('Playback started');
                    
                } catch (error) {
                    console.error('Error:', error);
                    this.showError('Failed to play channel');
                }
            }

            /**
             * Open video player
             */
            openPlayer(channel) {
                // Look for existing player
                let playerDiv = document.getElementById('player-modal');
                if (playerDiv) playerDiv.remove();
                
                // Create new player
                playerDiv = document.createElement('div');
                playerDiv.id = 'player-modal';
                playerDiv.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.95);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 9999;
                `;
                
                playerDiv.innerHTML = `
                    <div style="position: relative; width: 90%; height: 90%; background: #000; border-radius: 8px; overflow: hidden;">
                        <button style="position: absolute; top: 10px; right: 10px; width: 40px; height: 40px; background: rgba(0,0,0,0.7); border: none; color: white; font-size: 20px; cursor: pointer; border-radius: 50%; z-index: 10000;" onclick="this.closest('#player-modal').remove()">‚úï</button>
                        <video id="video-player" controls autoplay style="width: 100%; height: 100%; background: #000;"></video>
                        <div style="position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(transparent, rgba(0,0,0,0.9)); padding: 20px; color: white;">
                            <h2 style="margin: 0 0 5px 0;">${channel.name}</h2>
                            <p style="margin: 0; opacity: 0.7;">${channel.group}</p>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(playerDiv);
            }

            /**
             * Add/remove from favorites
             */
            toggleFavorite(channelId) {
                const index = this.favorites.indexOf(channelId);
                
                if (index > -1) {
                    this.favorites.splice(index, 1);
                } else {
                    this.favorites.push(channelId);
                }
                
                this.saveFavorites();
                this.renderChannels();
            }

            /**
             * ŸáŸÑ ÿßŸÑŸÇŸÜÿßÿ© ŸÖŸÅÿ∂ŸÑÿ©
             */
            isFavorite(channelId) {
                return this.favorites.includes(channelId);
            }

            /**
             * ÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸÅÿ∂ŸÑÿ©
             */
            saveFavorites() {
                localStorage.setItem('livetv_favorites', JSON.stringify(this.favorites));
            }

            /**
             * Load favorites
             */
            loadFavorites() {
                const saved = localStorage.getItem('livetv_favorites');
                return saved ? JSON.parse(saved) : [];
            }

            /**
             * Display error message
             */
            showError(message) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                errorDiv.textContent = `${message}`;
                errorDiv.style.cssText = `
                    position: fixed;
                    top: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: #fee;
                    color: #c00;
                    padding: 12px 20px;
                    border-radius: 4px;
                    z-index: 10000;
                    font-weight: 600;
                `;
                
                document.body.appendChild(errorDiv);
                setTimeout(() => errorDiv.remove(), 4000);
            }

            /**
             * Display notification
             */
            showNotification(message) {
                const notifDiv = document.createElement('div');
                notifDiv.className = 'notification-message';
                notifDiv.textContent = message;
                notifDiv.style.cssText = `
                    position: fixed;
                    top: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: #fff3cd;
                    color: #856404;
                    padding: 12px 20px;
                    border-radius: 4px;
                    z-index: 10000;
                    font-weight: 600;
                    border: 1px solid #ffeeba;
                `;
                
                document.body.appendChild(notifDiv);
                setTimeout(() => notifDiv.remove(), 4000);
            }
        }

        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', () => {
            const app = new LiveTVApp();
        });

        // ============================================
        // Legacy Event Handlers (for compatibility)
        // ============================================

        function handleNavigation(event) {
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => item.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }

        function handleLogout() {
            console.log('ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨...');
            window.location.href = '/logout';
        }

        // Focus Navigation for TV Remote
        document.addEventListener('keydown', (event) => {
            const focusedElement = document.activeElement;

            switch (event.key) {
                case 'ArrowUp':
                    event.preventDefault();
                    moveFocus('up');
                    break;
                case 'ArrowDown':
                    event.preventDefault();
                    moveFocus('down');
                    break;
                case 'ArrowLeft':
                    event.preventDefault();
                    moveFocus('left');
                    break;
                case 'ArrowRight':
                    event.preventDefault();
                    moveFocus('right');
                    break;
                case 'Enter':
                    if (focusedElement && focusedElement.click) {
                        focusedElement.click();
                    }
                    break;
            }
        });

        function moveFocus(direction) {
            const focusableElements = Array.from(
                document.querySelectorAll('button, [href], input, [tabindex]')
            ).filter(el => el.offsetHeight > 0 && el.offsetWidth > 0);

            const currentIndex = focusableElements.indexOf(document.activeElement);
            let nextIndex = currentIndex === -1 ? 0 : currentIndex;

            switch (direction) {
                case 'up':
                    nextIndex = currentIndex > 0 ? currentIndex - 1 : focusableElements.length - 1;
                    break;
                case 'down':
                    nextIndex = currentIndex < focusableElements.length - 1 ? currentIndex + 1 : 0;
                    break;
                case 'left':
                    nextIndex = currentIndex > 0 ? currentIndex - 1 : focusableElements.length - 1;
                    break;
                case 'right':
                    nextIndex = currentIndex < focusableElements.length - 1 ? currentIndex + 1 : 0;
                    break;
            }

            focusableElements[nextIndex]?.focus();
        }
    </script>
    
    <!-- HLS.js for HLS/M3U8 streaming support -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    
    <script>
        // Simple Live TV Player
        let channels = [];
        let hls = null;
        const streamingManager = window.streamingManager || {};

        async function initLiveTV() {
            try {
                // Get token and playlist
                const tokenResp = await fetch('/api/stream/token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({})
                });

                const tokenData = await tokenResp.json();
                
                // Fetch playlist
                const playlistResp = await fetch(tokenData.playlist_url);
                const playlistText = await playlistResp.text();
                
                // Parse M3U
                const lines = playlistText.split('\n');
                const channelsMap = new Map();
                
                for (let i = 0; i < lines.length; i++) {
                    if (lines[i].startsWith('#EXTINF')) {
                        const name = lines[i].match(/,(.+)$/)?.[1]?.trim() || 'Unknown';
                        const logo = lines[i].match(/tvg-logo="([^"]*)"/)?.[1] || '';
                        const group = lines[i].match(/group-title="([^"]+)"/)?.[1] || 'Other';
                        const url = lines[i + 1]?.trim();
                        
                        if (url && url.startsWith('http')) {
                            channels.push({ id: name.replace(/\s+/g, '_'), name, logo, group, url, type: 'live-tv' });
                            
                            // Group by category
                            if (!channelsMap.has(group)) {
                                channelsMap.set(group, []);
                            }
                            channelsMap.get(group).push(channels[channels.length - 1]);
                        }
                    }
                }

                // Render categories
                const categoriesList = document.getElementById('categoriesList');
                categoriesList.innerHTML = `
                    <button class="category-item active" onclick="filterCategory('all')">
                        <span>ÿßŸÑŸÉŸÑ</span>
                        <span class="count">(${channels.length})</span>
                    </button>
                    <button class="category-item" onclick="filterCategory('favorites')">
                        <span>‚ô° ÿßŸÑŸÖŸÅÿ∂ŸÑÿ©</span>
                        <span class="count">(0)</span>
                    </button>
                `;
                
                for (const [group, items] of channelsMap) {
                    categoriesList.innerHTML += `
                        <button class="category-item" onclick="filterCategory('${group}')">
                            <span>${group}</span>
                            <span class="count">(${items.length})</span>
                        </button>
                    `;
                }

                // Render all channels
                filterCategory('all');

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('channelsGrid').innerHTML = '<div class="error-message">Failed to load channels</div>';
            }
        }

        function filterCategory(category) {
            const channelsGrid = document.getElementById('channelsGrid');
            const channelsTitle = document.getElementById('channelsTitle');
            const channelsCount = document.getElementById('channelsCount');
            
            let filtered = channels;
            let title = 'ÿ¨ŸÖŸäÿπ ÿßŸÑŸÇŸÜŸàÿßÿ™';

            if (category !== 'all') {
                filtered = channels.filter(ch => ch.group === category);
                title = category;
            }

            channelsTitle.textContent = title;
            channelsCount.textContent = `${filtered.length} ŸÇŸÜÿßÿ©`;

            channelsGrid.innerHTML = filtered.map((ch, idx) => `
                <div class="channel-card" onclick="playChannel('${ch.url}', '${ch.name}')">
                    <div class="channel-thumbnail">
                        <img src="${ch.logo}" alt="${ch.name}" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22%3E%3Crect fill=%22%23333%22 width=%22100%22 height=%22100%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 fill=%22%23999%22 font-size=%2214%22%3E${encodeURIComponent(ch.name.substring(0,3))}%3C/text%3E%3C/svg%3E'">
                        <div class="play-overlay">
                            <button class="play-btn" title="Play">‚ñ∂</button>
                        </div>
                    </div>
                    <div class="channel-info">
                        <h3 class="channel-name">${ch.name}</h3>
                        <div class="channel-meta">
                            <span class="channel-quality">HD</span>
                            <span class="channel-category">${ch.group}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function playChannel(url, name) {
            // üé¨ Step 1: ÿßÿ∑ŸÑÿ® play token ŸÖŸÜ ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ±
            fetch('/api/stream/play', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    stream_url: url,
                    content_id: name.replace(/\s+/g, '_'),
                    content_name: name
                })
            }).then(r => r.json()).then(data => {
                if (data.success && data.play_token) {
                    // Record as watched
                    recordWatchedChannel(url, name);
                    
                    // üé¨ Step 2: ÿßÿ∑ŸÑÿ® ÿßŸÑÿ±ÿßÿ®ÿ∑ ÿßŸÑŸÜŸáÿßÿ¶Ÿä ŸÖŸÜ /stream/live ŸÖÿπ ÿßŸÑÿ™ŸàŸÉŸÜ
                    fetch(`/stream/live?token=${data.play_token}`)
                        .then(r => r.json())
                        .then(streamData => {
                            if (streamData.success && streamData.play_url) {
                                // Open player in modal with authorized URL
                                const modal = document.createElement('div');
                                modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:9999;display:flex;align-items:center;justify-content:center';
                                
                                const videoHtml = `
                                    <div style="position:relative;width:90%;height:90%;background:#000;border-radius:8px">
                                        <button onclick="this.closest('div').parentElement.remove()" style="position:absolute;top:10px;right:10px;width:40px;height:40px;background:rgba(0,0,0,0.7);border:none;color:white;font-size:20px;cursor:pointer;border-radius:50%;z-index:10000">‚úï</button>
                                        <video id="modal-video" style="width:100%;height:100%;background:#000" controls autoplay></video>
                                    </div>
                                `;
                                modal.innerHTML = videoHtml;
                                document.body.appendChild(modal);

                                // Play stream
                                const video = modal.querySelector('#modal-video');
                                playStream(streamData.play_url, video);
                            } else {
                                showNotification('Error: ' + (streamData.error || 'Failed to get stream URL'));
                            }
                        })
                        .catch(err => console.error('Error:', err.message));
                } else {
                        showNotification('Error: ' + (data.message || 'Failed to get streaming token'));
                }
            }).catch(err => console.error('Error:', err.message));
        }

        function recordWatchedChannel(url, name) {
            try {
                const watched = JSON.parse(localStorage.getItem('watched_items') || '[]');
                
                // Remove if already exists
                const filtered = watched.filter(w => w.name !== name);
                
                // Add to front
                const item = {
                    id: name.replace(/\s+/g, '_'),
                    name: name,
                    logo: '',
                    group: 'Live TV',
                    type: 'live-tv',
                    streamUrl: url,
                    timestamp: Date.now(),
                    progress: 0
                };
                
                filtered.unshift(item);
                
                // Keep only last 50
                filtered.splice(50);
                
                // Save to localStorage
                localStorage.setItem('watched_items', JSON.stringify(filtered));
                
                console.log('‚úÖ ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ŸÖÿ¥ÿßŸáÿØÿ© ÿßŸÑŸÇŸÜÿßÿ©');
            } catch (error) {
                console.warn('‚ö†Ô∏è ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑŸÖÿ¥ÿßŸáÿØÿ©:', error);
            }
        }

        function playStream(streamUrl, videoElement) {
            if (hls) {
                hls.destroy();
            }

            if (Hls.isSupported()) {
                hls = new Hls();
                hls.loadSource(streamUrl);
                hls.attachMedia(videoElement);
                hls.on(Hls.Events.MANIFEST_PARSED, () => {
                    videoElement.play();
                });
            } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                videoElement.src = streamUrl;
                videoElement.play();
            }
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', initLiveTV);
    </script>
</body>
</html>
