<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Servo - Profile</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../../static/css/user/profile.css">
</head>
<body>
    <div class="container">
        <div class="main-wrapper">
            <!-- Sidebar Navigation -->
            {% include 'user/components/sidebar.html' %}
            
            <!-- Main Content -->
            <main class="main-content">
                <div class="profile-container">
                    <div class="profile-card">
                        <!-- Profile Header -->
                        <div class="profile-header">
                            <div class="profile-avatar">D</div>
                            <div class="profile-info">
                                <h1 class="profile-email">demo@tvapp.com</h1>
                                <div class="profile-status">
                                    <span class="status-badge premium">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z"></path>
                                        </svg>
                                        premium_sub
                                    </span>
                                    <span class="user-id">ID: u-123</span>
                                </div>
                            </div>
                        </div>

                        <!-- Profile Details Grid -->
                        <div class="details-grid">
                            <!-- Subscription Details Card -->
                            <div class="detail-card">
                                <h3 class="card-title">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M12 6v6l4 2"></path>
                                        <circle cx="12" cy="12" r="10"></circle>
                                    </svg>
                                    Subscription Details
                                </h3>
                                <div class="detail-content">
                                    <div class="detail-row">
                                        <span class="detail-label">Plan</span>
                                        <span class="detail-value">Gold Package (12 Months)</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">Status</span>
                                        <span class="detail-value active">Active</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">Expires On</span>
                                        <span class="detail-value">2025-10-15</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill"></div>
                                    </div>
                                    <p class="progress-text">245 remaining</p>
                                </div>
                            </div>

                            <!-- Device Info Card -->
                            <div class="detail-card">
                                <h3 class="card-title">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <rect width="14" height="20" x="5" y="2" rx="2" ry="2"></rect>
                                        <path d="M12 18h.01"></path>
                                    </svg>
                                    Device Info
                                </h3>
                                <div class="detail-content">
                                    <div class="detail-row">
                                        <span class="detail-label">Device ID</span>
                                        <span class="detail-value device-id" id="deviceId">dev-zzuuexy7i-17...</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">Activation Code</span>
                                        <span class="detail-value activation-code" id="activationCode">
                                            <span id="codeValue">-</span>
                                            <button class="copy-btn" title="نسخ الكود" onclick="copyToClipboard('codeValue')">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                                                    <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
                                                </svg>
                                            </button>
                                        </span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">App Version</span>
                                        <span class="detail-value">v2.1.0 Pro</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">Distributor</span>
                                        <span class="detail-value distributor" id="distributor">Official Reseller</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="action-buttons">
                            <button class="btn btn-primary">Renew Subscription</button>
                            <button class="btn btn-secondary">Check Updates</button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
                /**
        * Profile Page - Interactive Features
        * Handles navigation, button interactions, and TV remote compatibility
        */

        class ProfileManager {
            constructor() {
                this.navButtons = document.querySelectorAll('.nav-btn');
                this.actionButtons = document.querySelectorAll('.btn');
                this.currentFocusedElement = null;
                this.init();
            }

            init() {
                this.loadProfileData();
                this.setupNavigation();
                this.setupActionButtons();
                this.setupKeyboardNavigation();
            }

            /**
             * Load profile data from backend
             */
            async loadProfileData() {
                try {
                    const [profileRes, subscriptionRes] = await Promise.all([
                        fetch('/api/profile'),
                        fetch('/api/profile/subscription')
                    ]);

                    const profileData = await profileRes.json();
                    const subscriptionData = await subscriptionRes.json();

                    if (profileData.success) {
                        this.updateProfileUI(profileData.data);
                    }

                    if (subscriptionData.success) {
                        this.updateSubscriptionUI(subscriptionData.data);
                    }
                } catch (error) {
                    console.error('Error loading profile data:', error);
                }
            }

            /**
             * Update profile UI with data
             */
            updateProfileUI(data) {
                // Update device ID
                const deviceIdElement = document.querySelector('#deviceId');
                if (deviceIdElement) {
                    deviceIdElement.textContent = data.device_id || 'N/A';
                }

                // Update activation code
                const codeValueElement = document.querySelector('#codeValue');
                if (codeValueElement) {
                    codeValueElement.textContent = data.device_activation_code || '-';
                }

                // Update distributor
                const distributorElement = document.querySelector('#distributor');
                if (distributorElement) {
                    distributorElement.textContent = data.distributor || 'N/A';
                }

                // Update expiration date
                const expirationElement = document.querySelector('.expiration-date');
                if (expirationElement && data.expiration_date) {
                    const expiryDate = new Date(data.expiration_date);
                    expirationElement.textContent = expiryDate.toLocaleDateString();
                }

                // Update profile email/username
                const profileEmail = document.querySelector('.profile-email');
                if (profileEmail) {
                    profileEmail.textContent = data.username || data.device_name || 'User';
                }

                // Update profile avatar
                const profileAvatar = document.querySelector('.profile-avatar');
                if (profileAvatar && data.username) {
                    profileAvatar.textContent = data.username.charAt(0).toUpperCase();
                }
            }

            /**
             * Update subscription UI with data
             */
            updateSubscriptionUI(data) {
                const detailValues = document.querySelectorAll('.detail-value');
                
                // Plan
                if (detailValues[0]) {
                    const planText = data.plan || 'No Plan';
                    const durationText = data.is_lifetime ? ' (Lifetime)' : (data.duration_months ? ` (${data.duration_months} Months)` : '');
                    detailValues[0].textContent = planText + durationText;
                }

                // Status
                if (detailValues[1]) {
                    const statusSpan = detailValues[1];
                    statusSpan.textContent = data.status === 'active' ? 'Active' : 'Inactive';
                    statusSpan.className = `detail-value ${data.status === 'active' ? 'active' : ''}`;
                }

                // Expiration Date - إخفاء التاريخ إذا كان lifetime
                if (detailValues[2]) {
                    if (data.is_lifetime) {
                        detailValues[2].textContent = 'Lifetime';
                        detailValues[2].style.color = '#4CAF50';
                        detailValues[2].style.fontWeight = 'bold';
                    } else if (data.expiration_date) {
                        const expiryDate = new Date(data.expiration_date);
                        detailValues[2].textContent = expiryDate.toLocaleDateString();
                    }
                }

                // Update progress bar - إظهار الـ progress bar فقط للاشتراكات غير lifetime
                if (!data.is_lifetime && data.expiration_date) {
                    const remaining = this.calculateRemainingDays(data.expiration_date);
                    this.updateProgressBar(remaining, 365);
                } else if (data.is_lifetime) {
                    // إخفاء progress bar للاشتراكات lifetime
                    const progressBar = document.querySelector('.progress-bar');
                    const progressText = document.querySelector('.progress-text');
                    if (progressBar) progressBar.style.display = 'none';
                    if (progressText) progressText.style.display = 'none';
                }
            }

            /**
            * Setup navigation button click handlers
            */
            setupNavigation() {
                this.navButtons.forEach((button, index) => {
                    button.addEventListener('click', (e) => {
                        this.handleNavClick(e, index);
                    });

                    button.addEventListener('focus', () => {
                        this.currentFocusedElement = button;
                    });
                });
            }

            /**
            * Handle navigation button clicks
            */
            handleNavClick(event, index) {
                const navTitles = ['Home', 'My List', 'Live TV', 'Movies', 'Series', 'Profile', 'Settings'];
                const title = event.currentTarget.title || navTitles[index];

                // Remove active class from all buttons
                this.navButtons.forEach(btn => btn.classList.remove('active'));

                // Add active class to clicked button
                event.currentTarget.classList.add('active');

                console.log(`Navigation: ${title}`);
                // Add your navigation logic here
            }

            /**
            * Setup action button handlers
            */
            setupActionButtons() {
                this.actionButtons.forEach((button) => {
                    button.addEventListener('click', (e) => {
                        this.handleActionClick(e);
                    });

                    button.addEventListener('focus', () => {
                        this.currentFocusedElement = button;
                    });
                });
            }

            /**
            * Handle action button clicks
            */
            handleActionClick(event) {
                const button = event.currentTarget;
                const buttonText = button.textContent.trim();

                // Add click animation
                button.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    button.style.transform = '';
                }, 150);

                console.log(`Action clicked: ${buttonText}`);

                if (buttonText.toLowerCase().includes('renew')) {
                    this.handleRenewal();
                } else if (buttonText.toLowerCase().includes('update')) {
                    this.handleCheckUpdates();
                }
            }

            /**
            * Handle renewal action
            */
            handleRenewal() {
                console.log('Renewing subscription...');
                // Redirect to renewal page
                window.location.href = '/subscription/renew';
            }

            /**
            * Handle check updates action
            */
            handleCheckUpdates() {
                console.log('Checking for updates...');
                // Check for updates (would be implemented on backend)
                fetch('/api/updates/check')
                    .then(r => r.json())
                    .then(data => {
                        if (data.hasUpdates) {
                            console.log('Updates available');
                        }
                    })
                    .catch(e => console.log('Update check failed', e));
            }

            /**
            * Setup keyboard navigation for TV remote compatibility
            */
            setupKeyboardNavigation() {
                document.addEventListener('keydown', (e) => {
                    this.handleKeyPress(e);
                });
            }

            /**
            * Handle keyboard/remote key press
            */
            handleKeyPress(event) {
                const focusableElements = document.querySelectorAll('button, [tabindex]:not([tabindex="-1"])');
                const currentIndex = Array.from(focusableElements).indexOf(this.currentFocusedElement);

                switch (event.key) {
                    case 'ArrowUp':
                        event.preventDefault();
                        this.focusElement(currentIndex - 1, focusableElements);
                        break;
                    case 'ArrowDown':
                        event.preventDefault();
                        this.focusElement(currentIndex + 1, focusableElements);
                        break;
                    case 'ArrowLeft':
                        event.preventDefault();
                        this.focusElement(currentIndex - 1, focusableElements);
                        break;
                    case 'ArrowRight':
                        event.preventDefault();
                        this.focusElement(currentIndex + 1, focusableElements);
                        break;
                    case 'Enter':
                        event.preventDefault();
                        if (this.currentFocusedElement) {
                            this.currentFocusedElement.click();
                        }
                        break;
                    case 'Escape':
                        event.preventDefault();
                        console.log('Back/Menu action');
                        break;
                }
            }

            /**
            * Focus an element by index
            */
            focusElement(index, elements) {
                if (index >= 0 && index < elements.length) {
                    elements[index].focus();
                    this.currentFocusedElement = elements[index];
                }
            }

            /**
             * Calculate remaining days
             */
            calculateRemainingDays(expiryDate) {
                const today = new Date();
                const expiry = new Date(expiryDate);
                
                // تعيين الوقت إلى منتصف الليل للمقارنة الصحيحة
                today.setHours(0, 0, 0, 0);
                expiry.setHours(0, 0, 0, 0);
                
                const timeDiff = expiry - today;
                const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
                
                return daysDiff > 0 ? daysDiff : 0;
            }

            /**
             * Update progress bar
             */
            updateProgressBar(remaining, total) {
                const progressFill = document.querySelector('.progress-fill');
                const progressText = document.querySelector('.progress-text');

                if (progressFill && progressText) {
                    const percentage = (remaining / total) * 100;
                    progressFill.style.width = percentage + '%';
                    progressText.textContent = remaining + ' remaining';
                }
            }

            /**
            * Update profile data
            */
            updateProfileData(data) {
                if (data.email) {
                    const emailElement = document.querySelector('.profile-email');
                    if (emailElement) emailElement.textContent = data.email;
                }

                if (data.plan) {
                    const planElements = document.querySelectorAll('.detail-value');
                    if (planElements[0]) planElements[0].textContent = data.plan;
                }

                if (data.expiryDate) {
                    const expiryElements = document.querySelectorAll('.detail-value');
                    if (expiryElements[2]) expiryElements[2].textContent = data.expiryDate;
                }
            }

            /**
            * Get profile data
            */
            getProfileData() {
                return {
                    email: document.querySelector('.profile-email').textContent,
                    status: document.querySelector('.status-badge.premium').textContent,
                    plan: document.querySelector('.detail-value').textContent,
                };
            }
        }

        /**
        * Initialize profile manager when DOM is ready
        */
        document.addEventListener('DOMContentLoaded', () => {
            window.profileManager = new ProfileManager();
            console.log('Profile page initialized');
        });

        /**
        * Handle logout
        */
        function handleLogout() {
            console.log('Logging out...');
            // Add your logout logic here
            // window.location.href = '/logout';
        }

        /**
        * Format date to readable format
        */
        function formatDate(dateString) {
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            return new Date(dateString).toLocaleDateString('en-US', options);
        }

        /**
        * Copy text to clipboard
        */
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            if (!element) return;

            const text = element.textContent;
            if (!text || text === '-') {
                console.log('No code to copy');
                return;
            }

            // Use modern Clipboard API
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => {
                    // Show feedback
                    const button = event.target.closest('.copy-btn');
                    if (button) {
                        const originalColor = button.style.color;
                        button.style.color = 'var(--green-success)';
                        setTimeout(() => {
                            button.style.color = originalColor;
                        }, 1500);
                    }
                }).catch(err => {
                    console.error('Failed to copy:', err);
                });
            } else {
                // Fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
            }
        }

        // Export for use in other modules
        if (typeof module !== 'undefined' && module.exports) {
            module.exports = {
                ProfileManager,
                formatDate,
            };
        }

    </script>
</body>
</html>
