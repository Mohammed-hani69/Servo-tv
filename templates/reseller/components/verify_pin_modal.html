<!-- Verify PIN Modal -->
<div id="verifyPinModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-50">
    <div class="bg-slate-900 border border-slate-800 rounded-xl shadow-2xl max-w-sm w-full mx-4">
        <!-- Modal Header -->
        <div class="bg-slate-900 border-b border-slate-800 px-6 py-4 flex items-center justify-between">
            <h2 class="text-lg font-bold text-white flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-lock text-blue-500"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                Verify PIN
            </h2>
            <button class="close-pin-modal text-slate-400 hover:text-white transition-colors" title="Close">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6l-12 12"></path><path d="M6 6l12 12"></path></svg>
            </button>
        </div>

        <!-- Modal Body -->
        <div class="p-6 space-y-4">
            <div class="bg-blue-500/10 border border-blue-500/20 rounded-lg p-4 text-sm text-blue-200 flex items-start gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-info flex-shrink-0 mt-0.5"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                <span>Enter your 4-digit PIN to proceed with code generation.</span>
            </div>

            <form id="verifyPinForm" class="space-y-4">
                <!-- PIN Input -->
                <div>
                    <label class="block text-sm font-semibold text-white mb-2">PIN Code</label>
                    <div class="relative">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-lock absolute left-3 top-1/2 -translate-y-1/2 text-slate-500"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                        <input 
                            type="password" 
                            id="pinInput" 
                            name="pin" 
                            placeholder="• • • •"
                            class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2.5 text-white placeholder-slate-500 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all outline-none pl-10 text-center text-xl tracking-widest font-bold"
                            maxlength="4"
                            inputmode="numeric"
                            pattern="[0-9]{4}"
                            required
                        >
                    </div>
                </div>

                <!-- Error Message -->
                <div id="pinError" class="hidden bg-red-500/10 border border-red-500/20 rounded-lg p-3 text-sm text-red-200 flex items-start gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-alert-circle flex-shrink-0 mt-0.5"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                    <span id="pinErrorText">Invalid PIN. Please try again.</span>
                </div>

                <!-- Buttons -->
                <div class="flex gap-3 pt-2 border-t border-slate-800">
                    <button 
                        type="button" 
                        class="close-pin-modal flex-1 bg-slate-700 hover:bg-slate-600 text-white py-2 rounded-lg transition-colors font-medium"
                    >
                        Cancel
                    </button>
                    <button 
                        type="submit" 
                        class="flex-1 bg-blue-600 hover:bg-blue-500 text-white py-2 rounded-lg transition-colors font-medium shadow-lg shadow-blue-900/20 flex items-center justify-center gap-2"
                    >
                        <span id="verifyBtnText">Verify PIN</span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-right hidden" id="loadingSpinner"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Verify PIN Modal for Export -->
<div id="verifyPinModalExport" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-50">
    <div class="bg-slate-900 border border-slate-800 rounded-xl shadow-2xl max-w-sm w-full mx-4">
        <!-- Modal Header -->
        <div class="bg-slate-900 border-b border-slate-800 px-6 py-4 flex items-center justify-between">
            <h2 class="text-lg font-bold text-white flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-lock text-blue-500"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                Verify PIN
            </h2>
            <button class="close-pin-modal-export text-slate-400 hover:text-white transition-colors" title="Close">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6l-12 12"></path><path d="M6 6l12 12"></path></svg>
            </button>
        </div>

        <!-- Modal Body -->
        <div class="p-6 space-y-4">
            <div class="bg-blue-500/10 border border-blue-500/20 rounded-lg p-4 text-sm text-blue-200 flex items-start gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-info flex-shrink-0 mt-0.5"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                <span>Enter your PIN to export your activation codes.</span>
            </div>

            <form id="verifyPinFormExport" class="space-y-4">
                <!-- PIN Input -->
                <div>
                    <label class="block text-sm font-semibold text-white mb-2">PIN Code</label>
                    <div class="relative">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-lock absolute left-3 top-1/2 -translate-y-1/2 text-slate-500"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                        <input 
                            type="password" 
                            id="pinInputExport" 
                            name="pin" 
                            placeholder="• • • •"
                            class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2.5 text-white placeholder-slate-500 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all outline-none pl-10 text-center text-xl tracking-widest font-bold"
                            maxlength="4"
                            inputmode="numeric"
                            pattern="[0-9]{4}"
                            required
                        >
                    </div>
                </div>

                <!-- Error Message -->
                <div id="pinErrorExport" class="hidden bg-red-500/10 border border-red-500/20 rounded-lg p-3 text-sm text-red-200 flex items-start gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-alert-circle flex-shrink-0 mt-0.5"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                    <span id="pinErrorTextExport">Invalid PIN. Please try again.</span>
                </div>

                <!-- Buttons -->
                <div class="flex gap-3 pt-2 border-t border-slate-800">
                    <button 
                        type="button" 
                        class="close-pin-modal-export flex-1 bg-slate-700 hover:bg-slate-600 text-white py-2 rounded-lg transition-colors font-medium"
                    >
                        Cancel
                    </button>
                    <button 
                        type="submit" 
                        class="flex-1 bg-blue-600 hover:bg-blue-500 text-white py-2 rounded-lg transition-colors font-medium shadow-lg shadow-blue-900/20 flex items-center justify-center gap-2"
                    >
                        <span id="verifyBtnTextExport">Verify PIN</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Close PIN modal
    function closePinModal() {
        document.getElementById('verifyPinModal').classList.add('hidden');
        document.getElementById('verifyPinModal').classList.remove('flex');
        document.getElementById('verifyPinForm').reset();
        document.getElementById('pinError').classList.add('hidden');
    }

    // Close PIN modal for export
    function closePinModalForExport() {
        document.getElementById('verifyPinModalExport').classList.add('hidden');
        document.getElementById('verifyPinModalExport').classList.remove('flex');
        document.getElementById('verifyPinFormExport').reset();
        document.getElementById('pinErrorExport').classList.add('hidden');
    }

    // Open PIN modal
    function openPinModal() {
        document.getElementById('verifyPinModal').classList.remove('hidden');
        document.getElementById('verifyPinModal').classList.add('flex');
        document.getElementById('pinInput').focus();
    }

    // Open PIN modal for export
    function openPinModalForExport() {
        document.getElementById('verifyPinModalExport').classList.remove('hidden');
        document.getElementById('verifyPinModalExport').classList.add('flex');
        document.getElementById('pinInputExport').focus();
    }

    // Initialize PIN modal events
    document.addEventListener('DOMContentLoaded', function() {
        // Close buttons
        document.querySelectorAll('.close-pin-modal').forEach(btn => {
            btn.addEventListener('click', closePinModal);
        });

        // Close buttons for export
        document.querySelectorAll('.close-pin-modal-export').forEach(btn => {
            btn.addEventListener('click', closePinModalForExport);
        });

        // Close when clicking backdrop
        document.getElementById('verifyPinModal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                closePinModal();
            }
        });

        // Close when clicking backdrop for export
        document.getElementById('verifyPinModalExport')?.addEventListener('click', function(e) {
            if (e.target === this) {
                closePinModalForExport();
            }
        });

        // PIN input - only allow digits
        document.getElementById('pinInput')?.addEventListener('input', function() {
            this.value = this.value.replace(/[^0-9]/g, '');
            if (this.value.length > 4) {
                this.value = this.value.slice(0, 4);
            }
        });

        // PIN input - prevent non-numeric input
        document.getElementById('pinInput')?.addEventListener('keypress', function(e) {
            if (!/[0-9]/.test(e.key)) {
                e.preventDefault();
            }
        });

        // PIN input for export - only allow digits
        document.getElementById('pinInputExport')?.addEventListener('input', function() {
            this.value = this.value.replace(/[^0-9]/g, '');
            if (this.value.length > 4) {
                this.value = this.value.slice(0, 4);
            }
        });

        // PIN input for export - prevent non-numeric input
        document.getElementById('pinInputExport')?.addEventListener('keypress', function(e) {
            if (!/[0-9]/.test(e.key)) {
                e.preventDefault();
            }
        });

        // Form submission
        document.getElementById('verifyPinForm')?.addEventListener('submit', async function(e) {
            e.preventDefault();

            const pin = document.getElementById('pinInput').value;
            const errorDiv = document.getElementById('pinError');
            const verifyBtn = this.querySelector('button[type="submit"]');
            const verifyBtnText = document.getElementById('verifyBtnText');
            const spinner = document.getElementById('loadingSpinner');

            // Validation
            if (!pin || pin.length !== 4) {
                errorDiv.classList.remove('hidden');
                document.getElementById('pinErrorText').textContent = 'PIN must be 4 digits';
                return;
            }

            // Show loading state
            verifyBtn.disabled = true;
            verifyBtnText.textContent = 'Verifying...';
            spinner.classList.remove('hidden');
            errorDiv.classList.add('hidden');

            try {
                // Verify PIN with backend
                const response = await fetch('/reseller/api/verify-pin', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ pin: pin })
                });

                const data = await response.json();

                if (data.success) {
                    // PIN is correct - close this modal and open code generation modal
                    closePinModal();
                    // Call the function to open generate code modal
                    if (typeof openModal === 'function') {
                        openModal();
                    }
                } else {
                    // PIN is incorrect
                    errorDiv.classList.remove('hidden');
                    document.getElementById('pinErrorText').textContent = data.message || 'Invalid PIN. Please try again.';
                    document.getElementById('pinInput').value = '';
                    document.getElementById('pinInput').focus();
                }
            } catch (error) {
                console.error('Error verifying PIN:', error);
                errorDiv.classList.remove('hidden');
                document.getElementById('pinErrorText').textContent = 'An error occurred. Please try again.';
            } finally {
                verifyBtn.disabled = false;
                verifyBtnText.textContent = 'Verify PIN';
                spinner.classList.add('hidden');
            }
        });

        // Form submission for export
        document.getElementById('verifyPinFormExport')?.addEventListener('submit', async function(e) {
            e.preventDefault();

            const pin = document.getElementById('pinInputExport').value;
            const errorDiv = document.getElementById('pinErrorExport');
            const verifyBtn = this.querySelector('button[type="submit"]');
            const verifyBtnText = document.getElementById('verifyBtnTextExport');

            // Validation
            if (!pin || pin.length !== 4) {
                errorDiv.classList.remove('hidden');
                document.getElementById('pinErrorTextExport').textContent = 'PIN must be 4 digits';
                return;
            }

            // Show loading state
            verifyBtn.disabled = true;
            verifyBtnText.textContent = 'Verifying...';
            errorDiv.classList.add('hidden');

            try {
                // Verify PIN with backend
                const response = await fetch('/reseller/api/verify-pin', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ pin: pin })
                });

                const data = await response.json();

                if (data.success) {
                    // PIN is correct - close this modal and export CSV
                    closePinModalForExport();
                    // Call the function to export CSV
                    if (typeof exportToCSV === 'function') {
                        exportToCSV();
                    }
                } else {
                    // PIN is incorrect
                    errorDiv.classList.remove('hidden');
                    document.getElementById('pinErrorTextExport').textContent = data.message || 'Invalid PIN. Please try again.';
                    document.getElementById('pinInputExport').value = '';
                    document.getElementById('pinInputExport').focus();
                }
            } catch (error) {
                console.error('Error verifying PIN:', error);
                errorDiv.classList.remove('hidden');
                document.getElementById('pinErrorTextExport').textContent = 'An error occurred. Please try again.';
            } finally {
                verifyBtn.disabled = false;
                verifyBtnText.textContent = 'Verify PIN';
            }
        });
    });
</script>
