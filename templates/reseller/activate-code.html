<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Servo - Activate Code</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../../static/css/reseller/activate-code.css">
    
</head>
<body>
    <div class="min-h-screen bg-slate-950 text-slate-200 font-sans flex overflow-hidden selection:bg-blue-500/30">
        <!-- Sidebar -->
        {% include 'reseller/components/sidebar.html' %}

        <!-- Main Content Area -->
        <div class="flex-1 flex flex-col h-screen overflow-hidden bg-[url('https://images.unsplash.com/photo-1451187580459-43490279c0fa?q=80&w=2000&auto=format&fit=crop')] bg-cover">
            <div class="absolute inset-0 bg-slate-950/90 backdrop-blur-sm z-0 pointer-events-none"></div>

            <!-- Header -->
            <header class="h-16 bg-slate-900/50 backdrop-blur-md border-b border-white/5 flex items-center justify-between px-8 z-10 relative">
                <div class="flex items-center gap-4 w-96">
                    <div class="relative w-full">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search absolute top-1/2 -translate-y-1/2 text-slate-500 left-3"><path d="m21 21-4.34-4.34"></path><circle cx="11" cy="11" r="8"></circle></svg>
                        <input placeholder="Search..." class="w-full bg-slate-800 border border-slate-700 rounded-full py-1.5 text-sm text-white focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all placeholder-slate-500 pl-10 pr-4" type="text">
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <button class="relative p-2 text-slate-400 hover:text-white transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bell"><path d="M10.268 21a2 2 0 0 0 3.464 0"></path><path d="M3.262 15.326A1 1 0 0 0 4 17h16a1 1 0 0 0 .74-1.673C19.41 13.956 18 12.499 18 8A6 6 0 0 0 6 8c0 4.499-1.411 5.956-2.738 7.326"></path></svg>
                        <span class="absolute top-1.5 right-1.5 w-2 h-2 bg-red-500 rounded-full border border-slate-900"></span>
                    </button>
                    <div class="h-8 w-px bg-slate-800 mx-2"></div>
                    <div class="flex items-center gap-3">
                        <div class="text-right hidden md:block">
                            <div class="text-sm font-bold text-white" id="reseller-name">Loading...</div>
                            <div class="text-xs text-slate-400" id="reseller-email">Loading...</div>
                        </div>
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-white font-bold shadow-lg" id="reseller-avatar">A</div>
                    </div>
                </div>
            </header>

            <!-- Main Content -->
            <main class="flex-1 overflow-y-auto p-8 relative z-10 scroll-smooth">
                <div class="space-y-6">
                    <!-- Page Header -->
                    <div class="flex justify-between items-center">
                        <div>
                            <h1 class="text-2xl font-bold text-white">Activation Codes</h1>
                            <p class="text-slate-400 text-sm">Manage all your activation codes here</p>
                        </div>
                        <div class="flex gap-3">
                            <button id="exportCsvBtn" class="flex items-center gap-2 px-4 py-2 bg-slate-800 text-slate-300 rounded-lg hover:bg-slate-700 transition-colors border border-slate-700">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-down"><path d="M6 22a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h8a2.4 2.4 0 0 1 1.704.706l3.588 3.588A2.4 2.4 0 0 1 20 8v12a2 2 0 0 1-2 2z"></path><path d="M14 2v5a1 1 0 0 0 1 1h5"></path><path d="M12 18v-6"></path><path d="m9 15 3 3 3-3"></path></svg>
                                Export CSV
                            </button>
                            <button id="openGenerateCodeModal" class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-500 transition-colors shadow-lg shadow-blue-900/20 font-medium">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus"><path d="M5 12h14"></path><path d="M12 5v14"></path></svg>
                                Activation Code
                            </button>
                        </div>
                    </div>

                    <!-- Search and Filter Bar -->
                    <div class="bg-slate-900/50 border border-slate-800 p-4 rounded-xl flex flex-wrap gap-4 items-center justify-between">
                        <div class="flex items-center gap-4 flex-1">
                            <div class="relative w-full max-w-md">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search absolute top-1/2 -translate-y-1/2 text-slate-500 left-3"><path d="m21 21-4.34-4.34"></path><circle cx="11" cy="11" r="8"></circle></svg>
                                <input id="searchInput" placeholder="Search codes..." class="w-full bg-slate-800 border border-slate-700 rounded-lg py-2 text-sm text-white focus:border-blue-500 outline-none pl-10 pr-4" type="text">
                            </div>
                            <div class="flex items-center gap-2 border-slate-700 border-l pl-4">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-funnel text-slate-500"><path d="M10 20a1 1 0 0 0 .553.895l2 1A1 1 0 0 0 14 21v-7a2 2 0 0 1 .517-1.341L21.74 4.67A1 1 0 0 0 21 3H3a1 1 0 0 0-.742 1.67l7.225 7.989A2 2 0 0 1 10 14z"></path></svg>
                                <select id="filterSelect" class="bg-slate-800 text-white text-sm outline-none cursor-pointer hover:text-white border border-slate-700 rounded px-3 py-1 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all">
                                    <option value="all">All Types</option>
                                    <option value="lifetime">Lifetime</option>
                                    <option value="1year">1 Year</option>
                                    <option value="active">Active</option>
                                    <option value="expired">Expired</option>
                                </select>
                            </div>
                        </div>
                        <div class="text-sm text-slate-500">Showing <span class="text-white font-bold">9</span> results</div>
                    </div>

                    <!-- Table -->
                    <div class="bg-slate-900/50 border border-slate-800 rounded-xl overflow-hidden shadow-xl">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-slate-900 border-b border-slate-800 text-xs font-bold text-slate-400 uppercase tracking-wider">
                                    <th class="p-4 text-left">Code</th>
                                    <th class="p-4 text-left">User</th>
                                    <th class="p-4 text-left">Plan</th>
                                    <th class="p-4 text-left">Devices</th>
                                    <th class="p-4 text-left">Status</th>
                                    <th class="p-4 text-left">Expiration</th>
                                    <th class="p-4 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="codesTable" class="divide-y divide-slate-800">
                                <!-- البيانات سيتم تحميلها من الـ API -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Include Verify PIN Modal -->
    {% include 'reseller/components/verify_pin_modal.html' %}

    <!-- Include Generate Code Modal -->
    {% include 'reseller/components/generate_code_modal.html' %}

    <script>
        // تحميل بيانات الموزع الحالي
        async function loadResellerProfile() {
            try {
                const response = await fetch('/reseller/api/profile');
                const result = await response.json();

                if (result.success && result.data) {
                    const reseller = result.data;
                    
                    // تحديث الاسم
                    document.getElementById('reseller-name').textContent = reseller.name || 'User';
                    
                    // تحديث الإيميل
                    document.getElementById('reseller-email').textContent = reseller.email || 'N/A';
                    
                    // تحديث الأفاتار (أول حرف من الاسم)
                    const firstLetter = (reseller.name || 'A').charAt(0).toUpperCase();
                    document.getElementById('reseller-avatar').textContent = firstLetter;
                }
            } catch (error) {
                console.error('Error loading reseller profile:', error);
            }
        }

        // تحميل البيانات من الـ API
        async function loadActivationCodes() {
            try {
                const response = await fetch('/reseller/api/my-codes');
                const result = await response.json();

                if (result.success && result.data) {
                    const codesTable = document.getElementById('codesTable');
                    codesTable.innerHTML = '';

                    // عرض كل كود
                    result.data.forEach(code => {
                        const expirationDate = code.expiration_date ? new Date(code.expiration_date) : null;
                        const expirationFormatted = expirationDate ? expirationDate.toISOString().split('T')[0] : 'N/A';
                        
                        // تحديد لون الحالة
                        let statusColor = 'bg-gray-500/10 text-gray-500 border-gray-500/20';
                        if (code.status === 'Active') {
                            statusColor = 'bg-emerald-500/10 text-emerald-500 border-emerald-500/20';
                        } else if (code.status === 'Expired') {
                            statusColor = 'bg-red-500/10 text-red-500 border-red-500/20';
                        } else if (code.status === 'Not Activated') {
                            statusColor = 'bg-yellow-500/10 text-yellow-500 border-yellow-500/20';
                        }

                        const row = document.createElement('tr');
                        row.className = 'hover:bg-slate-800/50 transition-colors group';
                        row.innerHTML = `
                            <td class="p-4">
                                <div class="font-mono font-bold text-blue-400 flex items-center gap-2">
                                    ${code.code}
                                    <button class="copy-btn opacity-0 group-hover:opacity-100 text-slate-500 hover:text-white transition-opacity" title="Copy" onclick="copyToClipboard('${code.code}')">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy">
                                            <rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect>
                                            <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path>
                                        </svg>
                                    </button>
                                </div>
                                <div class="text-xs text-slate-500 mt-1">${code.created_at ? new Date(code.created_at).toISOString().split('T')[0] : 'N/A'}</div>
                            </td>
                            <td class="p-4 text-sm text-white">${code.username}</td>
                            <td class="p-4 text-sm text-slate-300">
                                <div class="flex items-center gap-2">
                                    ${code.is_lifetime ? '<span class="px-2 py-1 rounded bg-purple-500/10 text-purple-400 border border-purple-500/20 text-xs font-bold">Lifetime</span>' : '<span class="px-2 py-1 rounded bg-blue-500/10 text-blue-400 border border-blue-500/20 text-xs font-bold">1 Year</span>'}
                                </div>
                            </td>
                            <td class="p-4">
                                <div class="flex items-center gap-2">
                                    <span class="text-xs text-slate-400">${code.max_devices} devices</span>
                                </div>
                            </td>
                            <td class="p-4">
                                <span class="px-2 py-1 rounded text-xs font-bold border ${statusColor}">
                                    ${code.status}
                                </span>
                            </td>
                            <td class="p-4 text-sm text-slate-300">
                                <div class="flex items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-calendar text-slate-500">
                                        <path d="M8 2v4"></path>
                                        <path d="M16 2v4"></path>
                                        <rect width="18" height="18" x="3" y="4" rx="2"></rect>
                                        <path d="M3 10h18"></path>
                                    </svg>
                                    ${expirationFormatted}
                                </div>
                            </td>
                            <td class="p-4 text-right">
                                <div class="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity justify-end">
                                    <button title="Extend" class="p-2 bg-slate-800 hover:bg-blue-600 hover:text-white rounded text-slate-400 transition-colors">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-refresh-ccw">
                                            <path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
                                            <path d="M3 3v5h5"></path>
                                            <path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"></path>
                                            <path d="M16 16h5v5"></path>
                                        </svg>
                                    </button>
                                    <button title="Suspend" class="p-2 bg-slate-800 hover:bg-orange-600 hover:text-white rounded text-slate-400 transition-colors">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-ban">
                                            <path d="M4.929 4.929 19.07 19.071"></path>
                                            <circle cx="12" cy="12" r="10"></circle>
                                        </svg>
                                    </button>
                                </div>
                            </td>
                        `;
                        codesTable.appendChild(row);
                    });

                    // تحديث عدد النتائج
                    const resultCount = document.querySelector('span[class="text-white font-bold"]');
                    if (resultCount) {
                        resultCount.textContent = result.count;
                    }
                }
            } catch (error) {
                console.error('Error loading codes:', error);
            }
        }

        // نسخ إلى الحافظة مع تنبيه بصري
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                // إنشاء تنبيه بصري
                const notification = document.createElement('div');
                notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-2 z-50 animate-pulse';
                notification.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                   copied
                `;
                document.body.appendChild(notification);
                setTimeout(() => {
                    notification.remove();
                }, 2000);
            });
        }

        // Initialize event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // تحميل بيانات الموزع
            loadResellerProfile();
            
            // تحميل البيانات من الـ API
            loadActivationCodes();

            // Export CSV button - مع التحقق من PIN
            document.getElementById('exportCsvBtn').addEventListener('click', function(e) {
                e.preventDefault();
                // فتح نافذة التحقق من PIN أولاً
                openPinModalForExport();
            });

            // Open modal when clicking Generate Code button
            document.getElementById('openGenerateCodeModal').addEventListener('click', function(e) {
                e.preventDefault();
                // فتح نافذة التحقق من PIN أولاً
                openPinModal();
            });

            // Search functionality - البحث بالاسم والكود
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('keyup', function() {
                    applyFilters();
                });
            }

            // Filter functionality - الفلتر حسب نوع الاشتراك والحالة
            const filterSelect = document.getElementById('filterSelect');
            if (filterSelect) {
                filterSelect.addEventListener('change', function() {
                    applyFilters();
                });
            }

            // دالة تطبيق الفلاتر والبحث معاً
            function applyFilters() {
                const query = (document.getElementById('searchInput').value || '').toLowerCase();
                const filterValue = document.getElementById('filterSelect').value;
                const rows = document.querySelectorAll('#codesTable tr');

                rows.forEach(row => {
                    const code = row.querySelector('td:first-child .font-mono')?.textContent.toLowerCase() || '';
                    const username = row.querySelector('td:nth-child(2)')?.textContent.toLowerCase() || '';
                    const statusSpan = row.querySelector('td:nth-child(5) span');
                    const planSpan = row.querySelector('td:nth-child(3) span');

                    const status = statusSpan?.textContent.toLowerCase() || '';
                    const planText = planSpan?.textContent.toLowerCase() || '';

                    // البحث في الكود والاسم
                    const matchesSearch = code.includes(query) || username.includes(query);

                    // الفلتر
                    let matchesFilter = true;
                    if (filterValue !== 'all') {
                        if (filterValue === 'lifetime') {
                            matchesFilter = planText.includes('lifetime');
                        } else if (filterValue === '1year') {
                            matchesFilter = planText.includes('1 year');
                        } else if (filterValue === 'active') {
                            matchesFilter = status.includes('active');
                        } else if (filterValue === 'expired') {
                            matchesFilter = status.includes('expired');
                        }
                    }

                    // عرض أو إخفاء الصف
                    row.style.display = (matchesSearch && matchesFilter) ? '' : 'none';
                });
            }

            // Export CSV function
            window.exportToCSV = async function() {
                try {
                    const response = await fetch('/reseller/api/export-codes');
                    
                    if (!response.ok) {
                        alert('Error exporting codes');
                        return;
                    }

                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `activation_codes_${new Date().toISOString().split('T')[0]}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);

                    // Show success notification
                    const notification = document.createElement('div');
                    notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-2 z-50';
                    notification.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                        Excel file exported successfully
                    `;
                    document.body.appendChild(notification);
                    setTimeout(() => {
                        notification.remove();
                    }, 3000);
                } catch (error) {
                    console.error('Error exporting CSV:', error);
                    alert('Error exporting codes');
                }
            };
        });
    </script>
</body>
</html>
